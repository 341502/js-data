/*!
* js-data
* @version 3.0.0-alpha.20 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t(e.JSData=e.JSData||{})}(this,function(e){"use strict";function t(e,t){var n=this;t||(t={});var r=t.localField;if(!r)throw new Error("localField is required");var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&(t.type===_||t.type===C))throw new Error("foreignKey is required");var o=t.localKeys,a=t.foreignKeys;if(!i&&!o&&!a&&t.type===x)throw new Error("one of (foreignKey, localKeys, foreignKeys) is required");if(O.isString(e)){if(t.relation=e,!O.isFunction(t.getRelation))throw new Error("you must provide a reference to the related mapper!")}else e&&(t.relation=e.name,Object.defineProperty(n,"relatedMapper",{value:e}));O.fillIn(n,t)}function n(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t?0:null===e?-1:null===t?1:t>e?-1:e>t?1:0)}function r(e,t,n){return e.splice(t,0,n),e}function i(e,t){return e.splice(t,1),e}function o(e,t,r){for(var i=0,o=e.length,a=void 0,u=void 0;o>i;){if(u=(i+o)/2|0,a=n(t,e[u],r),0===a)return{found:!0,index:u};0>a?o=u:i=u+1}return{found:!1,index:o}}var a={};a.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},a.get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},a.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},a.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};var u=1/0,s=1.7976931348623157e308,l="[object Boolean]",c="[object Date]",f="[object Function]",d="[object Number]",p="[object Object]",h="[object RegExp]",v="[object String]",y=Object.prototype.toString,g=/^(.+)\.(.+)$/,m=function(e){if(!e)return 0;if(e=+e,e===u||e===-u){var t=0>e?-1:1;return t*s}var n=e%1;return e===e?n?e-n:e:0},b=function(e){return y.call(e)},k=function(e){return!!e&&"object"===("undefined"==typeof e?"undefined":a.typeof(e))&&e.constructor===Object},w=function(e,t){if(!t)return e;var n=t.split(".");return n.forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e},A={Promise:Promise,_:function(e,t){for(var n in e){var r=e[n];void 0===t[n]&&!A.isFunction(r)&&n&&0!==n.indexOf("_")&&(t[n]=r)}},_forRelation:function(e,t,n,r){var i=t.relation,o=null,a=void 0;if(e||(e={}),e.with||(e.with=[]),(a=A._getIndex(e.with,i))>=0?o=i:(a=A._getIndex(e.with,t.localField))>=0&&(o=t.localField),e.withAll)return void n.call(r,t,{});if(o){var u={};A.fillIn(u,t.getRelation()),A.fillIn(u,e),u.with=e.with.slice(),u._activeWith=u.with.splice(a,1)[0],u.with.forEach(function(e,t){e&&0===e.indexOf(o)&&e.length>=o.length&&"."===e[o.length]?u.with[t]=e.substr(o.length+1):u.with[t]=""}),n.call(r,t,u)}},_getIndex:function(e,t){var n=-1;return e.forEach(function(e,r){return e===t?(n=r,!1):A.isObject(e)&&e.relation===t?(n=r,!1):void 0}),n},addHiddenPropsToTarget:function(e,t){var n={};A.forOwn(t,function(e,t){n[t]={writable:!0,value:e}}),Object.defineProperties(e,n)},areDifferent:function(e,t,n){n||(n={});var r=A.diffObjects(e,t,n),i=Object.keys(r.added).length+Object.keys(r.removed).length+Object.keys(r.changed).length;return i>0},classCallCheck:function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},copy:function(e,t,n,r,i,o){if(t){if(e===t)throw new Error("Cannot copy! Source and destination are identical.");if(n=n||[],r=r||[],A.isObject(e)){var a=n.indexOf(e);if(-1!==a)return r[a];n.push(e),r.push(t)}var u=void 0;if(A.isArray(e)){var s=void 0;for(t.length=0,s=0;s<e.length;s++)u=A.copy(e[s],null,n,r,i,o),A.isObject(e[s])&&(n.push(e[s]),r.push(u)),t.push(u)}else{A.isArray(t)?t.length=0:A.forOwn(t,function(e,n){delete t[n]});for(var l in e)if(e.hasOwnProperty(l)){if(A.isBlacklisted(l,i))continue;u=A.copy(e[l],null,n,r,i,o),A.isObject(e[l])&&(n.push(e[l]),r.push(u)),t[l]=u}}}else t=e,e&&(A.isArray(e)?t=A.copy(e,[],n,r,i,o):A.isDate(e)?t=new Date(e.getTime()):A.isRegExp(e)?(t=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]),t.lastIndex=e.lastIndex):A.isObject(e)&&(t=o?A.copy(e,{},n,r,i,o):A.copy(e,Object.create(Object.getPrototypeOf(e)),n,r,i,o)));return t},deepFillIn:function(e,t){return t&&A.forOwn(t,function(t,n){var r=e[n];k(t)&&k(r)?A.deepFillIn(r,t):e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)}),e},deepMixIn:function(e,t){return t&&A.forOwn(t,function(t,n){var r=e[n];k(t)&&k(r)?A.deepMixIn(r,t):e[n]=t}),e},diffObjects:function(e,t,n){n||(n={});var r=n.equalsFn,i=n.ignore,o={added:{},changed:{},removed:{}};return A.isFunction(r)||(r=A.strictEqual),A.forOwn(t,function(t,n){var a=e[n];A.isBlacklisted(n,i)||r(a,t)||(A.isUndefined(a)?o.removed[n]=void 0:r(a,t)||(o.changed[n]=a))}),A.forOwn(e,function(e,n){A.isUndefined(t[n])&&!A.isBlacklisted(n,i)&&(o.added[n]=e)}),o},equal:function(e,t){return e==t},eventify:function(e,t,n,r){e=e||this;var i={};t||n||(t=function(){return i},n=function(e){i=e}),Object.defineProperties(e,{emit:{enumerable:!!r,value:function(){for(var e=t.call(this)||{},n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r.shift(),a=e[o]||[],u=void 0;for(u=0;u<a.length;u++)a[u].f.apply(a[u].c,r);for(a=e.all||[],r.unshift(o),u=0;u<a.length;u++)a[u].f.apply(a[u].c,r)}},off:{enumerable:!!r,value:function(e,r){var i=t.call(this),o=i[e];if(o)if(r){for(var a=0;a<o.length;a++)if(o[a].f===r){o.splice(a,1);break}}else o.splice(0,o.length);else n.call(this,{})}},on:{enumerable:!!r,value:function(e,r,i){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({c:i,f:r})}}})},extend:function(e,t){var n=this,r=void 0;e||(e={}),t||(t={}),e.hasOwnProperty("constructor")?(r=e.constructor,delete e.constructor):r=function(){A.classCallCheck(this,r);for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var i=A.possibleConstructorReturn(this,(r.__super__||Object.getPrototypeOf(r)).apply(this,t));return i},r.prototype=Object.create(n&&n.prototype,{constructor:{configurable:!0,enumerable:!1,value:r,writable:!0}});var i=Object;return i.setPrototypeOf?i.setPrototypeOf(r,n):t.strictEs6Class?r.__proto__=n:A.forOwn(n,function(e,t){r[t]=e}),Object.defineProperty(r,"__super__",{configurable:!0,value:n}),A.addHiddenPropsToTarget(r.prototype,e),A.fillIn(r,t),r},fillIn:function(e,t){A.forOwn(t,function(t,n){e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)})},forEachRelation:function(e,t,n,r){var i=e.relationList||[];i.length&&i.forEach(function(e){A._forRelation(t,e,n,r)})},forOwn:function(e,t,n){var r=Object.keys(e),i=r.length,o=void 0;for(o=0;i>o;o++)t.call(n,e[r[o]],r[o],e)},fromJson:function(e){return A.isString(e)?JSON.parse(e):e},get:function(e,t){if(t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;return e[r]}},getSuper:function(e,t){var n=t?e:e.constructor;return n.__super__||Object.getPrototypeOf(n)||n.__proto__},hidePrototypeMethods:function(e){var t={};A.forOwn(e.prototype,function(e,n){A.isFunction(e)&&(t[n]={enumerable:!1,value:e})})},intersection:function(e,t){if(!e||!t)return[];var n=[],r=void 0,i=void 0,o=e.length;for(i=0;o>i;i++)r=e[i],-1===n.indexOf(r)&&-1!==t.indexOf(r)&&n.push(r);return n},isArray:Array.isArray,isBlacklisted:function(e,t){if(!t||!t.length)return!1;for(var n=void 0,r=0;r<t.length;r++)if(b(t[r])===h&&t[r].test(e)||t[r]===e)return n=e;return!!n},isBoolean:function(e){return b(e)===l},isBrowser:!1,isDate:function(e){return e&&"object"===("undefined"==typeof e?"undefined":a.typeof(e))&&b(e)===c},isFunction:function(e){return"function"==typeof e||e&&b(e)===f},isInteger:function(e){return b(e)===d&&e==m(e)},isNull:function(e){return null===e},isNumber:function(e){var t="undefined"==typeof e?"undefined":a.typeof(e);return"number"===t||e&&"object"===t&&b(e)===d},isObject:function(e){return b(e)===p},isRegExp:function(e){return b(e)===h},isSorN:function(e){return A.isString(e)||A.isNumber(e)},isString:function(e){return"string"==typeof e||e&&"object"===("undefined"==typeof e?"undefined":a.typeof(e))&&b(e)===v},isUndefined:function(e){return void 0===e},logify:function(e,t){A.addHiddenPropsToTarget(e,{dbg:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))},log:function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];if(e&&!r.length&&(r.push(e),e="debug"),"debug"!==e||this.debug){var o=e.toUpperCase()+": ("+(this.name||t)+")";if(console[e]){var a;(a=console)[e].apply(a,[o].concat(r))}else{var u;(u=console).log.apply(u,[o].concat(r))}}}})},omit:function(e,t){var n={};return A.forOwn(e,function(e,r){-1===t.indexOf(r)&&(n[r]=e)}),n},plainCopy:function(e){return A.copy(e,void 0,void 0,void 0,void 0,!0)},possibleConstructorReturn:function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a.typeof(t))&&"function"!=typeof t?e:t},reject:function(e){return A.Promise.reject(e)},resolve:function(e){return A.Promise.resolve(e)},set:function(e,t,n){if(A.isObject(t))A.forOwn(t,function(t,n){A.set(e,n,t)});else{var r=g.exec(t);r?w(e,r[1])[r[2]]=n:e[t]=n}},strictEqual:function(e,t){var n=e===t;return n||(A.isObject(e)&&A.isObject(t)?(A.forOwn(e,function(e,r){n=n&&A.strictEqual(e,t[r])}),A.forOwn(t,function(t,r){n=n&&A.strictEqual(t,e[r])})):A.isArray(e)&&A.isArray(t)&&e.forEach(function(e,r){n=n&&A.strictEqual(e,t[r])})),n},toJson:JSON.stringify,unset:function(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;e[r]=void 0}};try{A.isBrowser=!!window}catch(e){A.isBrowser=!1}var O=A,_="belongsTo",x="hasMany",C="hasOne";O.addHiddenPropsToTarget(t.prototype,{getRelation:function(){return this.relatedMapper},getLocalKeys:function(e){},getForeignKey:function(e){return this.type===_?O.get(e,this.foreignKey):O.get(e,this.mapper.idAttribute)},setForeignKey:function(e,t){var n=this;e&&t&&(n.type===_?O.set(e,n.foreignKey,O.get(t,n.getRelation().idAttribute)):!function(){var r=n.mapper.idAttribute;O.isArray(t)?t.forEach(function(t){O.set(t,n.foreignKey,O.get(e,r))}):O.set(t,n.foreignKey,O.get(e,r))}())},getLocalField:function(e){return O.get(e,this.localField)},setLocalField:function(e,t){return O.set(e,this.localField,t)}});var E=function(e,n,r){if(r||(r={}),!r.type)throw new Error("must specify relation type!");r.mapper=e,r.name=e.name;var i=new t(n,r);e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(i),e.relationFields.push(i.localField)},j=function(e,t){return t||(t={}),t.type=_,function(n){E(n,e,t)}},R=function(e,t){return t||(t={}),t.type=x,function(n){E(n,e,t)}},I=function(e,t){return t||(t={}),t.type=C,function(n){E(n,e,t)}},S={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},F=/([.*+?^=!:${}()|[\]\/\\])/g,P=/%/g,M=/_/g,L=function(e){return e.replace(F,"\\$1")},K=function(){function e(t){a.classCallCheck(this,e),O.classCallCheck(this,e),this.collection=t,this.data=null}return a.createClass(e,[{key:"compare",value:function(e,t,n,r){var i=e[t],o=O.get(n,i[0]),a=O.get(r,i[0]);return o&&O.isString(o)&&(o=o.toUpperCase()),a&&O.isString(a)&&(a=a.toUpperCase()),n||(n=null),r||(r=null),"DESC"===i[1]?o>a?-1:a>o?1:t<e.length-1?this.compare(e,t+1,n,r):0:a>o?-1:o>a?1:t<e.length-1?this.compare(e,t+1,n,r):0}},{key:"evaluate",value:function(t,n,r){return e.ops[n]?e.ops[n](t,r):0===n.indexOf("like")?!O.isNull(this.like(r,n.substr(4)).exec(t)):0===n.indexOf("notLike")?O.isNull(this.like(r,n.substr(7)).exec(t)):void 0}},{key:"like",value:function(e,t){return new RegExp("^"+L(e).replace(P,".*").replace(M,".")+"$",t)}},{key:"getData",value:function(){var e=this;return e.data||(e.data=e.collection.index.getAll()),e.data}},{key:"between",value:function(e,t,n){var r=this;if(n||(n={}),r.data)throw new Error("Cannot access index after first operation!");return r.data=r.collection.getIndex(n.index).between(e,t,n),r}},{key:"get",value:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=arguments[1],n=this;if(t||(t={}),n.data)throw new Error("Cannot access index after first operation!");return e&&!O.isArray(e)&&(e=[e]),e.length?(n.data=n.collection.getIndex(t.index).get(e),n):(n.getData(),n)}},{key:"getAll",value:function(){var e=this,t={};if(e.data)throw new Error("Cannot access index after first operation!");for(var n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];if(!r.length||1===r.length&&O.isObject(r[0]))return e.getData(),e;r.length&&O.isObject(r[r.length-1])&&(t=r[r.length-1],r.pop());var o=e.collection,a=o.getIndex(t.index);return e.data=[],r.forEach(function(t){e.data=e.data.concat(a.get(t))}),e}},{key:"filter",value:function(e,t){var n=this;return e||(e={}),n.getData(),O.isObject(e)?!function(){var t={};O.isObject(e.where)&&(t=e.where),O.forOwn(e,function(e,n){n in S||n in t||(t[n]={"==":e})});var r=[],i=[],o=[];O.forOwn(t,function(e,t){O.isObject(e)||(e={"==":e}),O.forOwn(e,function(e,n){r.push(t),i.push(n),o.push(e)})}),r.length&&!function(){var e=void 0,t=r.length;n.data=n.data.filter(function(a){var u=!0,s=!0;for(e=0;t>e;e++){var l=i[e],c="|"===l.charAt(0);l=c?l.substr(1):l;var f=n.evaluate(O.get(a,r[e]),l,o[e]);void 0!==f&&(s=u?f:c?s||f:s&&f),u=!1}return s})}();var a=e.orderBy||e.sort;O.isString(a)&&(a=[[a,"ASC"]]),O.isArray(a)||(a=null),a&&!function(){var e=0;a.forEach(function(e,t){O.isString(e)&&(a[t]=[e,"ASC"])}),n.data.sort(function(t,r){return n.compare(a,e,t,r)})}(),O.isNumber(e.skip)?n.skip(e.skip):O.isNumber(e.offset)&&n.skip(e.offset),O.isNumber(e.limit)&&n.limit(e.limit)}():O.isFunction(e)&&(n.data=n.data.filter(e,t)),n}},{key:"skip",value:function(e){if(!O.isNumber(e))throw new TypeError("skip: Expected number but found "+("undefined"==typeof e?"undefined":a.typeof(e))+"!");var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}},{key:"limit",value:function(e){if(!O.isNumber(e))throw new TypeError("limit: Expected number but found "+("undefined"==typeof e?"undefined":a.typeof(e))+"!");var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this}},{key:"forEach",value:function(e,t){return this.getData().forEach(e,t),this}},{key:"map",value:function(e,t){return this.data=this.getData().map(e,t),this}},{key:"mapCall",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return this.data=this.getData().map(function(t){return t[e].apply(t,n)}),this}},{key:"run",value:function(){var e=this.data;return this.data=null,e}}]),e}();K.ops={"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"!==":function(e,t){return e!==t},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},isectEmpty:function(e,t){return!O.intersection(e||[],t||[]).length},isectNotEmpty:function(e,t){return O.intersection(e||[],t||[]).length},in:function(e,t){return-1!==t.indexOf(e)},notIn:function(e,t){return-1===t.indexOf(e)},contains:function(e,t){return-1!==(e||[]).indexOf(t)},notContains:function(e,t){return-1===(e||[]).indexOf(t)}},K.extend=O.extend,O.hidePrototypeMethods(K);var N=function(){function e(t,n){if(a.classCallCheck(this,e),O.classCallCheck(this,e),t||(t=[]),!O.isArray(t))throw new Error("fieldList must be an array.");n||(n={}),this.fieldList=t,this.fieldGetter=n.fieldGetter,this.hashCode=n.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}return a.createClass(e,[{key:"set",value:function(t,n){O.isArray(t)||(t=[t]);var i=t.shift()||null,a=o(this.keys,i);if(0===t.length)if(a.found){var u=o(this.values[a.index],n,this.hashCode);u.found||r(this.values[a.index],u.index,n)}else r(this.keys,a.index,i),r(this.values,a.index,[n]);else if(a.found)this.values[a.index].set(t,n);else{r(this.keys,a.index,i);var s=new e([],{hashCode:this.hashCode});s.set(t,n),r(this.values,a.index,s)}}},{key:"get",value:function(e){O.isArray(e)||(e=[e]);var t=e.shift()||null,n=o(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index]:[]:n.found?this.values[n.index].get(e):[]}},{key:"getAll",value:function(){var e=[];return this.values.forEach(function(t){e=t.isIndex?e.concat(t.getAll()):e.concat(t)}),e}},{key:"visitAll",value:function(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})}},{key:"between",value:function(e,t,n){n||(n={}),O.isArray(e)||(e=[e]),O.isArray(t)||(t=[t]),O.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,n);return n.limit?r.slice(n.offset,n.limit+n.offset):r.slice(n.offset)}},{key:"_between",value:function(e,t,n){var r=[],i=e.shift(),a=t.shift(),u=void 0;if(u=void 0!==i?o(this.keys,i):{found:!1,index:0},0===e.length){u.found&&n.leftInclusive===!1&&(u.index+=1);for(var s=u.index;s<this.keys.length;s+=1){if(void 0!==a)if(n.rightInclusive){if(this.keys[s]>a)break}else if(this.keys[s]>=a)break;if(r=this.values[s].isIndex?r.concat(this.values[s].getAll()):r.concat(this.values[s]),n.limit&&r.length>=n.limit+n.offset)break}}else for(var l=u.index;l<this.keys.length;l+=1){var c=this.keys[l];if(c>a)break;if(r=this.values[l].isIndex?c===i?r.concat(this.values[l]._between(O.copy(e),t.map(function(){}),n)):c===a?r.concat(this.values[l]._between(e.map(function(){}),O.copy(t),n)):r.concat(this.values[l].getAll()):r.concat(this.values[l]),n.limit&&r.length>=n.limit+n.offset)break}return n.limit?r.slice(0,n.limit+n.offset):r}},{key:"peek",value:function(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]}},{key:"clear",value:function(){this.keys=[],this.values=[]}},{key:"insertRecord",value:function(e){var t=this.fieldList.map(function(t){return O.isFunction(t)?t(e)||null:e[t]||null});this.set(t,e)}},{key:"removeRecord",value:function(e){var t=this,n=void 0;return this.values.forEach(function(r,a){if(r.isIndex){if(r.removeRecord(e))return 0===r.keys.length&&(i(t.keys,a),i(t.values,a)),n=!0,!1}else{var u=o(r,e,t.hashCode);if(u.found)return i(r,u.index),0===r.length&&(i(t.keys,a),i(t.values,a)),n=!0,!1}}),n?e:void 0}},{key:"updateRecord",value:function(e){this.removeRecord(e),this.insertRecord(e)}}]),e}();O.hidePrototypeMethods(N);var T={idAttribute:"id",mapper:null,onConflict:"merge",recordOpts:null},U=function(){function e(t,n){a.classCallCheck(this,e);var r=this;O.classCallCheck(r,e),O.isObject(t)&&!O.isArray(t)&&(n=t,t=[]),O.isString(n)&&(n={idAttribute:n}),t||(t=[]),n||(n={}),n.recordOpts||(n.recordOpts={}),O.fillIn(r,n),O.fillIn(r,T),r._listeners={};var i=r.recordId();r.index=new N([i],{hashCode:function(e){return O.get(e,i)}}),r.indexes={},t.forEach(function(e){e=r.mapper?r.mapper.createRecord(e,r.recordOpts):e,r.index.insertRecord(e),e&&O.isFunction(e.on)&&e.on("all",r._onRecordEvent,r)})}return a.createClass(e,[{key:"_onRecordEvent",value:function(){this.emit.apply(this,arguments)}},{key:"add",value:function(e,t){var n=this;t||(t={}),O._(n,t),e=n.beforeAdd(e,t)||e;var r=!1,i=n.recordId();O.isObject(e)&&!O.isArray(e)&&(e=[e],r=!0),e=e.map(function(e){var r=n.recordId(e);if(!O.isSorN(r))throw new TypeError(i+": Expected string or number, found "+("undefined"==typeof r?"undefined":a.typeof(r))+"!");var o=n.get(r);if(e===o)return o;if(o){var u=t.onConflict||n.onConflict;"merge"===u?O.deepMixIn(o,e):"replace"===u&&(O.forOwn(o,function(t,n){n===i||e.hasOwnProperty(n)||delete o[n]}),o.set(e)),e=o,n.updateIndexes(e)}else e=n.mapper?n.mapper.createRecord(e,n.recordOpts):e,n.index.insertRecord(e),O.forOwn(n.indexes,function(t,n){t.insertRecord(e)}),e&&O.isFunction(e.on)&&e.on("all",n._onRecordEvent,n);return e});var o=r?e.length?e[0]:void 0:e;return n.emit("add",o),n.afterAdd(e,t,o)||o}},{key:"afterAdd",value:function(){}},{key:"afterRemove",value:function(){}},{key:"afterRemoveAll",value:function(){}},{key:"beforeAdd",value:function(){}},{key:"beforeRemove",value:function(){}},{key:"beforeRemoveAll",value:function(){}},{key:"between",value:function(e,t,n){return this.query().between(e,t,n).run()}},{key:"createIndex",value:function(e,t,n){var r=this;O.isString(e)&&void 0===t&&(t=[e]),n||(n={}),n.hashCode=n.hashCode||function(e){return r.recordId(e)};var i=r.indexes[e]=new N(t,n);return r.index.visitAll(i.insertRecord,i),r}},{key:"filter",value:function(e,t){return this.query().filter(e,t).run()}},{key:"forEach",value:function(e,t){this.index.visitAll(e,t)}},{key:"get",value:function(e){var t=this.query().get(e).run();return t.length?t[0]:void 0}},{key:"getAll",value:function(){var e;return(e=this.query()).getAll.apply(e,arguments).run()}},{key:"getIndex",value:function(e){var t=e?this.indexes[e]:this.index;if(!t)throw new Error("Index "+e+" does not exist!");return t}},{key:"limit",value:function(e){return this.query().limit(e).run()}},{key:"map",value:function(e,t){var n=[];return this.index.visitAll(function(r){n.push(e.call(t,r))}),n}},{key:"mapCall",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=[];return this.index.visitAll(function(t){i.push(t[e].apply(t,n))}),i}},{key:"recordId",value:function(e){if(e)return O.get(e,this.recordId());var t=this;return t.mapper?t.mapper.idAttribute:t.idAttribute||"id"}},{key:"query",value:function(){return new K(this)}},{key:"reduce",value:function(e,t){var n=this.getAll();return n.reduce(e,t)}},{key:"remove",value:function(e,t){var n=this;t||(t={}),n.beforeRemove(e,t);var r=n.get(e);return r&&(n.index.removeRecord(r),O.forOwn(n.indexes,function(e,t){e.removeRecord(r)}),r&&O.isFunction(r.off)&&(r.off("all",n._onRecordEvent,n),n.emit("remove",r))),n.afterRemove(e,t,r)||r}},{key:"removeAll",value:function(e,t){var n=this;t||(t={}),n.beforeRemoveAll(e,t);var r=n.filter(e);return r.forEach(function(e){n.remove(n.recordId(e),t)}),n.afterRemoveAll(e,t,r)||r}},{key:"skip",value:function(e){return this.query().skip(e).run()}},{key:"toJSON",value:function(e){return this.mapCall("toJSON",e)}},{key:"updateIndex",value:function(e,t){t||(t={}),this.getIndex(t.index).updateRecord(e)}},{key:"updateIndexes",value:function(e){var t=this;t.index.updateRecord(e),O.forOwn(t.indexes,function(t,n){t.updateRecord(e)})}}]),e}();U.extend=O.extend,O.eventify(U.prototype,function(){return this._listeners},function(e){this._listeners=e}),O.hidePrototypeMethods(U);var D=function(){function e(t,n){a.classCallCheck(this,e);var r=this;O.classCallCheck(r,e),t||(t={}),n||(n={});var i={};Object.defineProperties(r,{_get:{enumerable:!1,value:function(e){return O.get(i,e)}},_set:{enumerable:!1,value:function(e,t){return O.set(i,e,t)}},_unset:{enumerable:!1,value:function(e){return O.unset(i,e)}}});var o=r._set;o("creating",!0),n.noValidate&&o("noValidate",!0),O.fillIn(r,t),o("creating",!1),o("noValidate",!1),o("previous",O.copy(t))}return a.createClass(e,[{key:"_set",value:function(e,t){}},{key:"_get",value:function(e){}},{key:"_unset",value:function(e){}},{key:"_mapper",value:function(){var e=this.constructor;if(!e.mapper)throw new Error("This recordClass has no Mapper!");return e.mapper}},{key:"get",value:function(e){return O.get(this,e)}},{key:"set",value:function(e,t,n){var r=this;O.isObject(e)&&(n=t),n||(n={}),n.silent&&r._set("silent",!0),O.set(r,e,t),r._get("eventId")||r._set("silent")}},{key:"unset",value:function(e,t){this.set(e,void 0,t)}},{key:"hashCode",value:function(){var e=this;return O.get(e,e._mapper().idAttribute)}},{key:"changes",value:function(e){var t=this;return e||(e={}),O.diffObjects(t,t._get("previous"),e)}},{key:"hasChanges",value:function(e){var t=this,n=!!(t._get("changed")||[]).length;return n||O.areDifferent(t,t._get("previous"),e)}},{key:"commit",value:function(){var e=this;return e._set("changed"),e._set("previous",O.copy(e)),e}},{key:"previous",value:function(e){var t=this;return e?t._get("previous."+e):t._get("previous")}},{key:"revert",value:function(e){var t=this,n=t._get("previous")||{};return e||(e={}),e.preserve||(e.preserve=[]),O.forOwn(t,function(r,i){i!==t._mapper().idAttribute&&!n.hasOwnProperty(i)&&t.hasOwnProperty(i)&&-1===e.preserve.indexOf(i)&&delete t[i]}),O.forOwn(n,function(n,r){-1===e.preserve.indexOf(r)&&(t[r]=n)}),t.commit(),t}},{key:"schema",value:function(e){var t=this._mapper().schema;return e?t[e]:t}},{key:"create",value:function(e){return this._mapper().create(this,e)}},{key:"beforeSave",value:function(){}},{key:"save",value:function(e){var t=void 0,n=void 0,r=this,i=r._mapper();return e||(e={}),O._(r,e),n=e.adapter=i.getAdapterName(e),t=e.op="beforeSave",O.resolve(r[t](e)).then(function(){return t=e.op="save",i.dbg(t,r,e),i.getAdapter(n)[t](i,r,e)}).then(function(n){return t=e.op="afterSave",O.resolve(r[t](n,e)).then(function(t){return n=t||n,e.raw?(r.set(n.data),n.data=r):r.set(n),i.end(n,e)})})}},{key:"afterSave",value:function(){}},{key:"beforeLoadRelations",value:function(){}},{key:"loadRelations",value:function(e,t){var n=void 0,r=this,i=r._mapper(),o=i.relationList||[];return e||(e=[]),t||(t={}),O._(i,t),t.adapter=i.getAdapterName(t),n=t.op="beforeLoadRelations",O.resolve(r[n](e,t)).then(function(){return O.isString(e)&&(e=[e]),n=t.op="loadRelations",i.dbg(n,r,e,t),Promise.all(o.map(function(e){if(O.isFunction(e.load))return e.load(i,e,r,t);var n=void 0;if("hasMany"===e.type&&e.foreignKey)n=e.getRelation().findAll(a.defineProperty({},e.foreignKey,O.get(r,i.idAttribute)),t);else if(e.foreignKey){var o=O.get(r,e.foreignKey);O.isSorN(o)&&(n=e.getRelation().find(o,t))}else e.localKeys?n=e.getRelation().findAll(a.defineProperty({},e.getRelation().idAttribute,{in:O.get(r,e.localKeys)}),t):e.foreignKeys&&(n=e.getRelation().findAll(a.defineProperty({},e.getRelation().idAttribute,{contains:O.get(r,i.idAttribute)}),t));return n&&(n=n.then(function(n){t.raw&&(n=n.data),O.set(r,e.localField,"hasOne"===e.type?n.length?n[0]:void 0:n)})),n}))}).then(function(){return n=t.op="afterLoadRelations",O.resolve(r[n](e,t)).then(function(){return r})})}},{key:"afterLoadRelations",value:function(){}},{key:"destroy",value:function(e){var t=this._mapper();return t.destroy(O.get(this,t.idAttribute),e)}},{key:"toJSON",value:function(e){var t=this,n=this.constructor,r=n.mapper;if(r)return r.toJSON(this,e);var i=function(){var e={};return O.forOwn(t,function(t,n){e[n]=O.copy(t)}),{v:e}}();return"object"===("undefined"==typeof i?"undefined":a.typeof(i))?i.v:void 0}}]),e}();D.extend=O.extend,O.eventify(D.prototype,function(){return this._get("events")},function(e){this._set("events",e)}),O.hidePrototypeMethods(D);var q={array:O.isArray,boolean:O.isBoolean,integer:O.isInteger,null:O.isNull,number:O.isNumber,object:O.isObject,string:O.isString},Q=function(e,t){var n="";return e&&(n+=O.isNumber(e)?"["+e+"]":t?"."+e:""+e),n},J=function(e){e||(e={});var t="",n=e.path||[];return n.forEach(function(e){t+=Q(e,t)}),t+=Q(e.prop,t)},B=function(e,t,n){return{expected:t,actual:""+e,path:J(n)}},$=function(e,t,n,r){r.push(B(e,t,n))},H=function(e,t,n,r){var i=n[e];return t.length>i?B(t.length,"length no more than "+i,r):void 0},V=function(e,t,n,r){var i=n[e];return t.length<i?B(t.length,"length no less than "+i,r):void 0},G={allOf:function(e,t,n){var r=[];return t.allOf.forEach(function(t){r=r.concat(re(e,t,n)||[])}),r.length?void 0:r},anyOf:function(e,t,n){var r=!1,i=[];return t.anyOf.forEach(function(t){var o=re(e,t,n);o?i=i.concat(o):r=!0}),r?void 0:i},dependencies:function(e,t,n){},enum:function(e,t,n){var r=t.enum;return-1===r.indexOf(e)?B(e,"one of ("+r.join(", ")+")",n):void 0},items:function e(t,n,r){r||(r={});for(var e=n.items,i=[],o=O.isArray(e),a=t.length,u=0;a>u;u++)o&&(e=n.items[u]),r.prop=u,i=i.concat(re(t[u],e,r)||[]);return i.length?i:void 0},maximum:function e(t,n,r){var e=n.maximum,i=n.exclusiveMaximum;return("undefined"==typeof t?"undefined":a.typeof(t))===("undefined"==typeof e?"undefined":a.typeof(e))&&(i?t>e:t>=e)?B(t,"no more than "+e,r):void 0},maxItems:function(e,t,n){return H("maxItems",e,t,n)},maxLength:function(e,t,n){return H("maxLength",e,t,n)},maxProperties:function e(t,n,r){var e=n.maxProperties,i=Object.keys(t).length;return i>e?B(i,"no more than "+e+" properties",r):void 0},minimum:function e(t,n,r){var e=n.minimum,i=n.exclusiveMinimum;return("undefined"==typeof t?"undefined":a.typeof(t))===("undefined"==typeof e?"undefined":a.typeof(e))&&(i?e>t:e>=t)?B(t,"no less than "+e,r):void 0},minItems:function(e,t,n){return V("minItems",e,t,n)},minLength:function(e,t,n){return V("minLength",e,t,n)},minProperties:function e(t,n,r){var e=n.minProperties,i=Object.keys(t).length;return e>i?B(i,"no more than "+e+" properties",r):void 0},multipleOf:function(e,t,n){},not:function(e,t,n){return re(e,t.not,n)?void 0:B("succeeded","should have failed",n)},oneOf:function(e,t,n){var r=!1,i=[];return t.oneOf.forEach(function(t){var o=re(e,t,n);if(o)i=i.concat(o);else{if(r)return i=[B("valid against more than one","valid against only one",n)],r=!1,!1;r=!0}}),r?void 0:i},pattern:function e(t,n,r){var e=n.pattern;return O.isString(t)&&!t.match(e)?B(t,e,r):void 0},properties:function e(t,n,r){r||(r={});var i=O.isUndefined(n.additionalProperties)?!0:n.additionalProperties,o={},e=n.properties||{},a=n.patternProperties||{},u=[];O.forOwn(t,function(e,t){o[t]=void 0}),O.forOwn(e||{},function(e,n){O.isUndefined(t[n])&&!O.isUndefined(e.default)&&(t[n]=O.copy(e.default)),r.prop=n,u=u.concat(re(t[n],e,r)||[]),delete o[n]}),O.forOwn(a,function(e,n){O.forOwn(o,function(i,a){a.match(n)&&(r.prop=a,u=u.concat(re(t[a],e,r)||[]),delete o[a])})});var s=Object.keys(o);return i===!1?s.length&&$("extra fields: "+s.join(", "),"no extra fields",r,u):O.isObject(i)&&s.forEach(function(e){r.prop=e,u=u.concat(re(t[e],i,r)||[])}),u.length?u:void 0},required:function e(t,n,r){var e=n.required,i=[];return r.existingOnly||e.forEach(function(e){if(O.isUndefined(O.get(t,e))){var n=r.prop;r.prop=e,$(void 0,"a value",r,i),r.prop=n}}),i.length?i:void 0},type:function e(t,n,r){var e=n.type,i=void 0;if(O.isString(e)&&(e=[e]),e.forEach(function(e){return q[e](t,n,r)?(i=e,!1):void 0}),!i)return B(t?"undefined"==typeof t?"undefined":a.typeof(t):""+t,"one of ("+e.join(", ")+")",r);var o=de[i];return o?o(t,n,r):void 0},uniqueItems:function(e,t,n){if(e&&e.length&&t.uniqueItems){var r=e.length,i=void 0,o=void 0,a=void 0;for(o=r-1;o>0;o--)for(i=e[o],a=o-1;a>=0;a--)if(i===e[a])return B(i,"no duplicates",n)}}},W=function(e,t,n,r){return!O.isUndefined(n[e])&&G[e](t,n,r)},z=function(e,t,n,r){var i=[];return e.forEach(function(e){i=i.concat(W(e,t,n,r)||[])}),i.length?i:void 0},X=["enum","type","allOf","anyOf","oneOf","not"],Y=["items","maxItems","minItems","uniqueItems"],Z=["multipleOf","maximum","minimum"],ee=["maxProperties","minProperties","required","properties","dependencies"],te=["maxLength","minLength","pattern"],ne=function(e,t,n){return z(X,e,t,n)},re=function e(t,n,r){var i=[];r||(r={});
var o=void 0,a=r.prop;if(!O.isUndefined(n)){if(!O.isObject(n))throw new Error('Invalid schema at path: "'+r.path+'"');return O.isUndefined(r.path)&&(r.path=[]),O.isUndefined(r.prop)||(o=!0,r.path.push(r.prop),r.prop=void 0),n.extends&&(i=O.isFunction(n.extends.validate)?i.concat(n.extends.validate(t,r)||[]):i.concat(e(t,n.extends,r)||[])),O.isUndefined(t)?(n.required===!0&&$(t,"a value",r,i),o&&(r.path.pop(),r.prop=a),i.length?i:void 0):(i=i.concat(ne(t,n,r)||[]),o&&(r.path.pop(),r.prop=a),i.length?i:void 0)}},ie="changing",oe="changed",ae="creating",ue="eventId",se="noValidate",le="silent",ce="validation failed",fe=function(e,t,n){var r={enumerable:O.isUndefined(t.enumerable)?!0:!!t.enumerable},i="props."+e,o="previous."+e,a=n.getter,u=n.setter,s=n.unsetter;return r.get=function(){return this._get(i)},r.set=function(n){var r=this,l=r[a],c=r[u],f=r[s];if(!l(se)){var d=t.validate(n);if(d){var p=new Error(ce);throw p.errors=d,p}}return t.track&&!l(ae)&&!function(){var t=l(o),a=l(i),u=l(ie),s=l(oe);u||(s=[]);var d=s.indexOf(e);a!==n&&-1===d&&s.push(e),t===n&&d>=0&&s.splice(d,1),s.length||(u=!1,f(ie),f(oe),l(ue)&&(clearTimeout(l(ue)),f(ue))),!u&&s.length&&(c(oe,s),c(ie,!0),c(ue,setTimeout(function(){if(f(oe),f(ue),f(ie),!l(le)){var e=void 0;for(e=0;e<s.length;e++)r.emit("change:"+s[e],r,O.get(r,s[e]));r.emit("change",r,r.changes())}f(le)},0)))}(),c(i,n),n},r},de={array:function(e,t,n){return z(Y,e,t,n)},integer:function(e,t,n){return de.numeric(e,t,n)},number:function(e,t,n){return de.numeric(e,t,n)},numeric:function(e,t,n){return z(Z,e,t,n)},object:function(e,t,n){return z(ee,e,t,n)},string:function(e,t,n){return z(te,e,t,n)}},pe=function(){function e(t){a.classCallCheck(this,e),t||(t={}),O.fillIn(this,t),t.properties&&O.forOwn(t.properties,function(n,r){n instanceof e||(t.properties[r]=new e(n))})}return a.createClass(e,[{key:"apply",value:function(e,t){t||(t={}),t.getter=t.getter||"_get",t.setter=t.setter||"_set",t.unsetter=t.unsetter||"_unset";var n=this.properties||{};O.forOwn(n,function(n,r){Object.defineProperty(e,r,fe(r,n,t))})}},{key:"validate",value:function(t,n){return e.validate(t,this,n)}}]),e}();pe.extend=O.extend,pe.types=q,pe.typeGroupValidators=de,pe.validationKeywords=G,pe.validate=re;var he=function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r=this,i=t[t.length-1];r.dbg.apply(r,[i.op].concat(t)),(i.notify||void 0===i.notify&&r.notify)&&setTimeout(function(){r.emit.apply(r,[i.op].concat(t))})},ve=function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r=this,i=t[t.length-2];r.dbg.apply(r,[i.op].concat(t)),(i.notify||void 0===i.notify&&r.notify)&&setTimeout(function(){r.emit.apply(r,[i.op].concat(t))})},ye={applySchema:!0,debug:!1,defaultAdapter:"http",idAttribute:"id",lifecycleMethods:{count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function(e,t,n,r){return[t,e.toJSON(n,r),r]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function(e,t,n,r){return[e.toJSON(t,r),n,r]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function(e,t,n){return[t.map(function(t){return e.toJSON(t,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},name:null,notify:O.isBrowser,raw:!1,schema:null},ge=function(){function e(t){a.classCallCheck(this,e),this.afterCount=ve,this.afterCreate=ve,this.afterCreateMany=ve,this.afterDestroy=ve,this.afterDestroyAll=ve,this.afterFind=ve,this.afterFindAll=ve,this.afterSum=ve,this.afterUpdate=ve,this.afterUpdateAll=ve,this.afterUpdateMany=ve,this.beforeCreate=he,this.beforeCreateMany=he,this.beforeCount=he,this.beforeDestroy=he,this.beforeDestroyAll=he,this.beforeFind=he,this.beforeFindAll=he,this.beforeSum=he,this.beforeUpdate=he,this.beforeUpdateAll=he,this.beforeUpdateMany=he;var n=this;if(O.classCallCheck(n,e),t||(t={}),Object.defineProperty(n,"_adapters",{value:void 0,writable:!0}),Object.defineProperty(n,"_listeners",{value:{},writable:!0}),Object.defineProperty(n,"recordClass",{value:void 0,writable:!0}),O.fillIn(n,t),O.fillIn(n,O.copy(ye)),!n.name)throw new Error("mapper cannot function without a name!");n._adapters||(n._adapters={}),n.schema instanceof pe||(n.schema=new pe(n.schema||{})),O.isUndefined(n.recordClass)&&(n.recordClass=D.extend()),n.recordClass&&(n.recordClass.mapper=n,O.getSuper(n.recordClass,!0)===D&&n.schema&&n.schema.apply&&n.applySchema&&n.schema.apply(n.recordClass.prototype))}return a.createClass(e,[{key:"_end",value:function(e,t,n){var r=this;if(t.raw&&O._(t,e),n)return e;var i=t.raw?e.data:e;return O.isArray(i)&&i.length&&O.isObject(i[0])?i=i.map(function(e){return r.createRecord(e)}):O.isObject(i)&&(i=r.createRecord(i)),t.raw?e.data=i:e=i,e}},{key:"belongsTo",value:function(e,t){return j(e,t)(this)}},{key:"count",value:function(e,t){return this.crud("count",e,t)}},{key:"create",value:function(e,t){var n=void 0,r=void 0,i=this;return e||(e={}),t||(t={}),O._(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeCreate",O.resolve(i[n](e,t)).then(function(o){e=O.isUndefined(o)?e:o;var a={};t.with||(t.with=[]);var u=[];return O.forEachRelation(i,t,function(t,n){var r=t.getLocalField(e);t.type===_&&r&&u.push(t.getRelation().create(r,n).then(function(r){var i=n.raw?r.data:r;t.setLocalField(a,i),t.setForeignKey(e,i)}))}),O.Promise.all(u).then(function(){return n=t.op="create",i.dbg(n,e,t),O.resolve(i.getAdapter(r)[n](i,i.toJSON(e,{with:t.pass||[]}),t))}).then(function(n){var r=t.raw?n.data:n;return u=[],O.forEachRelation(i,t,function(n,i){var o=n.getLocalField(e);if(o){var s=void 0;n.type===x?(n.setForeignKey(r,o),s=n.getRelation().createMany(o,i).then(function(e){n.setLocalField(r,t.raw?e.data:e)})):n.type===C?(n.setForeignKey(r,o),s=n.getRelation().create(o,i).then(function(e){n.setLocalField(r,t.raw?e.data:e)})):n.type===_&&n.getLocalField(a)&&n.setLocalField(r,n.getLocalField(a)),s&&u.push(s)}}),O.Promise.all(u).then(function(){return n})})}).then(function(r){return r=i._end(r,t),n=t.op="afterCreate",O.resolve(i[n](e,t,r)).then(function(e){return O.isUndefined(e)?r:e})})}},{key:"createInstance",value:function(e,t){return this.createRecord(e,t)}},{key:"createMany",value:function(e,t){var n=void 0,r=void 0,i=this;return e||(e=[]),t||(t={}),O._(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeCreateMany",O.resolve(i[n](e,t)).then(function(o){e=O.isUndefined(o)?e:o;var a={};t.with||(t.with=[]);var u=[];return O.forEachRelation(i,t,function(t,n){var r=e.map(function(e){return t.getLocalField(e)}).filter(function(e){return e});t.type===_&&r.length===e.length&&u.push(t.getRelation().createMany(r,n).then(function(r){var i=n.raw?r.data:r;t.setLocalField(a,i),e.forEach(function(e,n){t.setForeignKey(e,i[n])})}))}),O.Promise.all(u).then(function(){n=t.op="createMany";var o=e.map(function(e){return i.toJSON(e,{with:t.pass||[]})});return i.dbg(n,e,t),O.resolve(i.getAdapter(r)[n](i,o,t))}).then(function(n){var r=t.raw?n.data:n;return u=[],O.forEachRelation(i,t,function(n,o){var s=e.map(function(e){return n.getLocalField(e)}).filter(function(e){return e});if(s.length===e.length){var l=n.getLocalField(a),c=void 0;n.type===x?i.log("warn","deep createMany of hasMany type not supported!"):n.type===C?(r.forEach(function(e,t){n.setForeignKey(e,s[t])}),c=n.getRelation().createMany(s,o).then(function(e){var i=t.raw?e.data:e;r.forEach(function(e,t){n.setLocalField(e,i[t])})})):n.type===_&&l&&l.length===r.length&&r.forEach(function(e,t){n.setLocalField(e,l[t])}),c&&u.push(c)}}),O.Promise.all(u).then(function(){return n})})}).then(function(r){return r=i._end(r,t),n=t.op="afterCreateMany",O.resolve(i[n](e,t,r)).then(function(e){return O.isUndefined(e)?r:e})})}},{key:"createRecord",value:function(e,t){var n=this,r=n.recordClass,i=n.relationList||[];return i.forEach(function(t){var n=t.getRelation(),r=t.getLocalField(e);O.isArray(r)&&r.length&&!n.is(r[0])?t.setLocalField(e,r.map(function(e){return t.getRelation().createRecord(e)})):O.isObject(r)&&!n.is(r)&&t.setLocalField(e,t.getRelation().createRecord(r))}),r?e instanceof r?e:new r(e,t):e}},{key:"crud",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=this,o=i.lifecycleMethods[e];if(!o)throw new Error(e+": No such CRUD method!");var u=""+e.charAt(0).toUpperCase()+e.substr(1),s="before"+u,l="after"+u,c=void 0,f=void 0;o.defaults.forEach(function(e,t){O.isUndefined(n[t])&&(n[t]=O.copy(e))});var d=n[n.length-1];return O._(i,d),f=d.adapter=i.getAdapterName(d),c=d.op=s,O.resolve(i[c].apply(i,a.toConsumableArray(n))).then(function(t){var r;return O.isUndefined(o.beforeAssign)||(n[o.beforeAssign]=O.isUndefined(t)?n[o.beforeAssign]:t),c=d.op=e,n=o.adapterArgs?o.adapterArgs.apply(o,[i].concat(a.toConsumableArray(n))):n,i.dbg.apply(i,[c].concat(a.toConsumableArray(n))),O.resolve((r=i.getAdapter(f))[c].apply(r,[i].concat(a.toConsumableArray(n))))}).then(function(e){return e=i._end(e,d,!!o.skip),n.push(e),c=d.op=l,O.resolve(i[c].apply(i,a.toConsumableArray(n))).then(function(t){return O.isUndefined(t)?e:t})})}},{key:"destroy",value:function(e,t){return this.crud("destroy",e,t)}},{key:"destroyAll",value:function(e,t){return this.crud("destroyAll",e,t)}},{key:"find",value:function(e,t){return this.crud("find",e,t)}},{key:"findAll",value:function(e,t){return this.crud("findAll",e,t)}},{key:"getAdapter",value:function(e){var t=this;t.dbg("getAdapter","name:",e);var n=t.getAdapterName(e);if(!n)throw new ReferenceError(n+" not found!");return t.getAdapters()[n]}},{key:"getAdapterName",value:function(e){return e||(e={}),O.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter}},{key:"getAdapters",value:function(){return this._adapters}},{key:"getSchema",value:function(){return this.schema}},{key:"hasMany",value:function(e,t){return R(e,t)(this)}},{key:"hasOne",value:function(e,t){return I(e,t)(this)}},{key:"is",value:function(e){var t=this.recordClass;return t?e instanceof t:!1}},{key:"registerAdapter",value:function(e,t,n){var r=this;n||(n={}),r.getAdapters()[e]=t,(n===!0||n.default)&&(r.defaultAdapter=e)}},{key:"sum",value:function(e,t,n){return this.crud("sum",e,t,n)}},{key:"toJSON",value:function(e,t){var n=this;t||(t={});var r=(n?n.relationFields:[])||[],i={},o=void 0;return n&&n.schema&&(o=n.schema.properties||{},O.forOwn(o,function(t,n){i[n]=O.plainCopy(e[n])})),o||(o={}),t.strict||O.forOwn(e,function(e,t){o[t]||-1!==r.indexOf(t)||(i[t]=O.plainCopy(e))}),n&&t.withAll&&(t.with=r.slice()),n&&t.with&&(O.isString(t.with)&&(t.with=[t.with]),O.forEachRelation(n,t,function(t,n){var r=t.getLocalField(e);r&&(O.isArray(r)?t.setLocalField(i,r.map(function(e){return t.getRelation().toJSON(e,n)})):t.setLocalField(i,t.getRelation().toJSON(r,n)))})),i}},{key:"update",value:function(e,t,n){return this.crud("update",e,t,n)}},{key:"updateAll",value:function(e,t,n){return this.crud("updateAll",e,t,n)}},{key:"updateMany",value:function(e,t){return this.crud("updateMany",e,t)}}]),e}();ge.extend=O.extend,O.logify(ge.prototype,"Mapper"),O.eventify(ge.prototype,function(){return this._listeners},function(e){this._listeners=e}),O.hidePrototypeMethods(ge);var me=["count","create","createMany","createRecord","dbg","destroy","destroyAll","emit","find","findAll","getSchema","is","log","off","on","sum","toJSON","update","updateAll","updateMany"],be=function(){function e(t){a.classCallCheck(this,e);var n=this;O.classCallCheck(n,e),t||(t={}),O.fillIn(n,t),n.mapperDefaults=n.mapperDefaults||{},n.mapperClass=n.mapperClass||ge,n._adapters={},n._mappers={}}return a.createClass(e,[{key:"defineMapper",value:function(e,t){var n=this;if(O.isObject(e)){if(t=e,!t.name)throw new Error("name is required!");e=t.name}else if(!O.isString(e))throw new Error("name is required!");t||(t={}),t.name=e,t.relations||(t.relations={});var r=t.mapperClass||n.mapperClass;delete t.mapperClass,O.fillIn(t,n.mapperDefaults);var i=n._mappers[e]=new r(t);return i.name=e,i._adapters=n.getAdapters(),O.forOwn(i.relations,function(e,t){O.forOwn(e,function(e,r){O.isObject(e)&&(e=[e]),e.forEach(function(e){e.getRelation=function(){return n.getMapper(r)};var o=n._mappers[r]||r;t===_?i.belongsTo(o,e):t===C?i.hasOne(o,e):t===x&&i.hasMany(o,e)})})}),i}},{key:"defineResource",value:function(e,t){return this.defineMapper(e,t)}},{key:"getAdapter",value:function(e){var t=this,n=t.getAdapterName(e);if(!n)throw new ReferenceError(n+" not found!");return t.getAdapters()[n]}},{key:"getAdapterName",value:function(e){return e||(e={}),O.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter}},{key:"getAdapters",value:function(){return this._adapters}},{key:"getMapper",value:function(e){var t=this._mappers[e];if(!t)throw new ReferenceError(e+" is not a registered mapper!");return t}},{key:"registerAdapter",value:function(e,t,n){var r=this;n||(n={}),r.getAdapters()[e]=t,(n===!0||n.default)&&(r.mapperDefaults.defaultAdapter=e,O.forOwn(r._mappers,function(t){t.defaultAdapter=e}))}}]),e}();be.extend=O.extend;var ke={};me.forEach(function(e){ke[e]=function(t){for(var n,r=arguments.length,i=Array(r>1?r-1:0),o=1;r>o;o++)i[o-1]=arguments[o];return(n=this.getMapper(t))[e].apply(n,i)}}),O.addHiddenPropsToTarget(be.prototype,ke),O.hidePrototypeMethods(be);var we=U.extend({constructor:function(e,t){var n=this;if(O.classCallCheck(n,we),O.getSuper(n).call(n,e,t),n._added={},!n.datastore)throw new Error("This collection must have a datastore!");return n},_onRecordEvent:function(){for(var e=this,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];O.getSuper(e).prototype._onRecordEvent.apply(e,n);var i=n[0];O.isString(i)&&0===i.indexOf("change")&&e.updateIndexes(n[1])},add:function(e,t){var n=this,r=n.datastore,i=n.mapper,o=i.relationList||[],a=(new Date).getTime(),u=!!i.recordClass,s=void 0;return O.isObject(e)&&!O.isArray(e)&&(s=!0,e=[e]),o.length&&e.length&&i.relationList.forEach(function(t){var n=t.relation,i=r.getMapper(n),o=i.idAttribute,a=t.foreignKey,u=r.getCollection(n),s=t.type,l=s===x,c=O.isUndefined(t.add)?!0:!!t.add,f=void 0;e.forEach(function(e){if(f=t.getLocalField(e),O.isFunction(t.add))t.add(r,t,e);else if(f){if(l)f=f.map(function(n){return n!==u.get(u.recordId(n))&&(a&&t.setForeignKey(e,n),c&&(n=u.add(n))),n}),t.localKeys&&O.set(e,t.localKeys,f.map(function(e){return O.get(e,o)}));else{var n=O.get(f,o);f!==u.get(n)&&(t.setForeignKey(e,f),c&&(f=u.add(f)))}t.setLocalField(e,f)}})}),e=O.getSuper(n).prototype.add.call(n,e,t),e.forEach(function(e){n._added[n.recordId(e)]=a,u&&e._set("$",a)}),s?e[0]:e},remove:function(e,t){var n=this;delete n._added[e];var r=O.getSuper(n).prototype.remove.call(n,e,t);if(r){var i=n.mapper;i.recordClass&&r._set("$")}return r},removeAll:function(e,t){var n=this,r=O.getSuper(n).prototype.removeAll.call(n,e,t);return r.forEach(function(e){delete n._added[n.recordId(e)]}),r}});O.hidePrototypeMethods(we);var Ae={linkRelations:O.isBrowser},Oe=function(e){function t(e){var n;a.classCallCheck(this,t);var r=a.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e)),i=r;return O.classCallCheck(i,t),O.getSuper(i).call(i,e),i.collectionClass=i.collectionClass||we,i._collections={},O.fillIn(i,Ae),i._pendingQueries={},i._completedQueries={},n=i,a.possibleConstructorReturn(r,n)}return a.inherits(t,e),a.createClass(t,[{key:"_callSuper",value:function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return a.get(Object.getPrototypeOf(t.prototype),e,this).apply(this,r)}},{key:"_end",value:function(e,t,n){return n.raw?(t.data=this.getCollection(e).add(t.data,n),t):t=this.getCollection(e).add(t,n)}},{key:"create",value:function(e,t,n){var r=this;return n||(n={}),r._callSuper("create",e,t,n).then(function(t){return r._end(e,t,n)})}},{key:"createMany",value:function(e,t,n){var r=this;return n||(n={}),r._callSuper("createMany",e,t,n).then(function(t){return r._end(e,t,n)})}},{key:"defineMapper",value:function(e,t){var n=this,r=O.getSuper(n).prototype.defineMapper.call(n,e,t);n._pendingQueries[e]={},n._completedQueries[e]={},r.relationList||Object.defineProperty(r,"relationList",{value:[]});var i=n._collections[e]=new n.collectionClass(null,{_added:{},datastore:n,mapper:r}),o=r.schema||{},a=o.properties||{};O.forOwn(a,function(e,t){e.indexed&&i.createIndex(t)}),i.createIndex("addedTimestamps",["$"],{fieldGetter:function(e){return i._added[i.recordId(e)]}});var u=n.linkRelations;return u&&r.relationList.forEach(function(e){var t=e.relation,o=e.localField,a="links."+o,s=e.foreignKey,l=e.type,c=O.isUndefined(e.link)?u:e.link,f={index:s},d=void 0;l===_?(i.indexes[s]||i.createIndex(s),d={get:function(){var r=this;if(!r._get("$")||!c)return r._get(a);var i=e.getForeignKey(r),o=O.isUndefined(i)?void 0:n.getCollection(t).get(i);return r._set(a,o),o},set:function(t){var n=this;return n._set(a,t),e.setForeignKey(n,t),i.updateIndex(n,f),e.getLocalField(n)}}):l===x?!function(){var r=e.localKeys,o=e.foreignKeys;n._collections[t]&&s&&!n.getCollection(t).indexes[s]&&n.getCollection(t).createIndex(s),d={get:function(){var i=this;if(!i._get("$")||!c)return i._get(a);var u=e.getForeignKey(i),l=void 0,f=n.getCollection(t);if(s)l=f.getAll(u,{index:s});else if(r){var d=O.get(i,r)||[],p=O.isArray(d)?d:Object.keys(d);l=f.getAll.apply(f,p)}else if(o){var h={};O.set(h,"where."+o+".contains",u),l=f.filter(h)}return i._set(a,l),l},set:function(u){var l=this,c=i.recordId(l),d=n.getCollection(t);return l._set(a,u),s&&(e.setForeignKey(l,u),O.isArray(u)&&u.forEach(function(e){d.updateIndex(e,f)})),r?O.set(l,r,u.map(function(e){return d.recordId(e)})):o&&u.forEach(function(e){var t=O.get(e,o);t?-1===t.indexOf(c)&&t.push(c):O.set(e,o,[c])}),e.getLocalField(l)}}}():l===C&&(d={get:function(){var r=this;if(!r._get("$")||!c)return r._get(a);var i=e.getForeignKey(r),o=n.getCollection(t).getAll(i,{index:s}),u=o.length?o[0]:void 0;return r._set(a,u),u},set:function(r){var i=this;return i._set(a,r),e.setForeignKey(i,r),n.getCollection(t).updateIndex(r,f),e.getLocalField(i)}}),d&&(d.enumerable=O.isUndefined(e.enumerable)?!0:e.enumerable,e.get&&!function(){var t=d.get;d.get=function(){var n=this;return e.get(e,this,function(){for(var e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];return t.apply(n,r)})}}(),e.set&&!function(){var t=d.set;d.set=function(n){var r=this;return e.set(e,this,n,function(e){return t.call(r,void 0===e?n:e)})}}(),Object.defineProperty(r.recordClass.prototype,o,d))}),r}},{key:"destroy",value:function(e,t,n){var r=this;return n||(n={}),r._callSuper("destroy",e,t,n).then(function(i){return n.raw?i.data=r.getCollection(e).remove(t,n):i=r.getCollection(e).remove(t,n),delete r._pendingQueries[e][t],delete r._completedQueries[e][t],i})}},{key:"destroyAll",value:function(e,t,n){var r=this;return n||(n={}),r._callSuper("destroyAll",e,t,n).then(function(i){n.raw?i.data=r.getCollection(e).removeAll(t,n):i=r.getCollection(e).removeAll(t,n);var o=r.hashQuery(e,t,n);return delete r._pendingQueries[e][o],delete r._completedQueries[e][o],i})}},{key:"find",value:function(e,t,n){var r=this;n||(n={});var i=r._pendingQueries[e][t];if(O.fillIn(n,r.getMapper(e)),i)return i;var o=r.cachedFind(e,t,n),a=void 0;return a=n.force||!o?r._pendingQueries[e][t]=r._callSuper("find",e,t,n).then(function(i){return delete r._pendingQueries[e][t],r._end(e,i,n)},function(n){return delete r._pendingQueries[e][t],O.reject(n)}).then(function(n){return r._completedQueries[e][t]=(new Date).getTime(),n}):O.resolve(o)}},{key:"findAll",value:function(e,t,n){var r=this;n||(n={});var i=r.hashQuery(e,t,n),o=r._pendingQueries[e][i];if(O.fillIn(n,r.getMapper(e)),o)return o;var a=r.cachedFindAll(e,t,n),u=void 0;return u=n.force||!a?r._pendingQueries[e][i]=r._callSuper("findAll",e,t,n).then(function(t){return delete r._pendingQueries[e][i],r._end(e,t,n)},function(t){return delete r._pendingQueries[e][i],O.reject(t)}).then(function(t){return r._completedQueries[e][i]=(new Date).getTime(),t}):O.resolve(a)}},{key:"cachedFind",value:function(e,t,n){return this.get(e,t,n)}},{key:"cachedFindAll",value:function(e,t,n){var r=this;return r._completedQueries[e][r.hashQuery(e,t,n)]?r.filter(e,t,n):void 0}},{key:"hashQuery",value:function(e,t,n){return O.toJson(t)}},{key:"getCollection",value:function(e){var t=this._collections[e];if(!t)throw new ReferenceError(e+" is not a registered collection!");return t}},{key:"update",value:function(e,t,n,r){var i=this;return r||(r={}),i._callSuper("update",e,t,n,r).then(function(t){return i._end(e,t,r)})}},{key:"updateAll",value:function(e,t,n,r){var i=this;return r||(r={}),i._callSuper("updateAll",e,t,n,r).then(function(t){return i._end(e,t,r)})}},{key:"updateMany",value:function(e,t,n){var r=this;return n||(n={}),r._callSuper("updateMany",e,t,n).then(function(t){return r._end(e,t,n)})}}]),t}(be),_e=["add","between","createIndex","filter","get","getAll","query","remove","removeAll","toJson"],xe={};_e.forEach(function(e){xe[e]=function(t){for(var n,r=arguments.length,i=Array(r>1?r-1:0),o=1;r>o;o++)i[o-1]=arguments[o];return(n=this.getCollection(t))[e].apply(n,i)}}),xe.inject=function(){return this.add.apply(this,arguments)},xe.eject=function(){return this.remove.apply(this,arguments)},xe.ejectAll=function(){return this.removeAll.apply(this,arguments)},O.logify(Oe.prototype,"DataStore"),O.addHiddenPropsToTarget(Oe.prototype,xe),O.hidePrototypeMethods(Oe);var Ce={alpha:"20",beta:"false",full:"3.0.0-alpha.20",major:parseInt("3",10),minor:parseInt("0",10),patch:parseInt("0",10)};e.version=Ce,e.utils=O,e.belongsToType=_,e.hasManyType=x,e.hasOneType=C,e.belongsTo=j,e.hasMany=R,e.hasOne=I,e.Collection=U,e.Container=be,e.DataStore=Oe,e.LinkedCollection=we,e.Mapper=ge,e.Query=K,e.Record=D,e.Schema=pe});
//# sourceMappingURL=js-data.min.map