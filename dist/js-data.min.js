/*!
* js-data
* @version 3.0.0-alpha.11 - Homepage <http://www.js-data.io/>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2015 Jason Dobry
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview Robust framework-agnostic data store.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.JSData={})}(this,function(e){"use strict";function t(e){return ue(e)===ne}function n(e){return!!e&&"object"===("undefined"==typeof e?"undefined":Q.typeof(e))&&e.constructor===Object}function r(e){return ue(e)===re}function i(e){return ue(e)===X}function o(e){return"function"==typeof e||e&&ue(e)===ee}function a(e){return ce(e)||he(e)}function u(e,t){if(t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;return e[r]}}function s(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;e[r]=void 0,delete e[r]}function f(e,t){if(!t)return e;var n=t.split(".");return n.forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e}function c(e,n,r){if(t(n))l(n,function(t,n){c(e,n,t)});else{var i=ge.exec(n);i?f(e,i[1])[i[2]]=r:e[n]=r}}function l(e,t,n){var r=Object.keys(e),i=r.length,o=void 0;for(o=0;i>o;o++)t.call(n,e[r[o]],r[o],e)}function d(e,t){return t&&l(t,function(e,t){var r=this[t];n(e)&&n(r)?d(r,e):this[t]=e},e),e}function p(e){return Promise.resolve(e)}function h(e){return Promise.reject(e)}function v(e,t){for(var n in e){var r=e[n];void 0===t[n]&&!o(r)&&n&&0!==n.indexOf("_")&&(t[n]=r)}}function g(e,t){if(!e||!t)return[];var n=[],r=void 0,i=void 0,o=e.length;for(i=0;o>i;i++)r=e[i],-1===n.indexOf(r)&&-1!==t.indexOf(r)&&n.push(r);return n}function m(e,t){l(t,function(t,n){e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)})}function y(e,t){if(!t||!t.length)return!1;for(var n=void 0,r=0;r<t.length;r++)if("[object RegExp]"===ue(t[r])&&t[r].test(e)||t[r]===e)return n=e;return!!n}function b(e){return ce(e)?JSON.parse(e):e}function x(e,n,i,o,a){if(n){if(e===n)throw new Error("Cannot copy! Source and destination are identical.");if(i=i||[],o=o||[],t(e)){var u=i.indexOf(e);if(-1!==u)return o[u];i.push(e),o.push(n)}var s=void 0;if(fe(e)){var f=void 0;for(n.length=0,f=0;f<e.length;f++)s=x(e[f],null,i,o,a),t(e[f])&&(i.push(e[f]),o.push(s)),n.push(s)}else{fe(n)?n.length=0:l(n,function(e,t){delete n[t]});for(var c in e)if(e.hasOwnProperty(c)){if(y(c,a))continue;s=x(e[c],null,i,o,a),t(e[c])&&(i.push(e[c]),o.push(s)),n[c]=s}}}else n=e,e&&(fe(e)?n=x(e,[],i,o,a):pe(e)?n=new Date(e.getTime()):r(e)?(n=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]),n.lastIndex=e.lastIndex):t(e)&&(n=x(e,Object.create(Object.getPrototypeOf(e)),i,o,a)));return n}function A(e,t,n){return""+t.toUpperCase()+n.toLowerCase()}function w(e){return e.replace(be,"").replace(xe,A)}function _(e){return e.split(ye).map(w).join("")}function O(e){return e=_(e),e?e.charAt(0).toLowerCase()+e.slice(1):e}function C(e,t,n,r){e=e||this;var i={};t||n||(t=function(){return i},n=function(e){i=e}),Object.defineProperties(e,{on:{enumerable:!!r,value:function(e,r,i){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({f:r,c:i})}},off:{enumerable:!!r,value:function(e,r){var i=t.call(this),o=i[e];if(o)if(r){for(var a=0;a<o.length;a++)if(o[a].f===r){o.splice(a,1);break}}else o.splice(0,o.length);else n.call(this,{})}},emit:{enumerable:!!r,value:function(){for(var e=t.call(this)||{},n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r.shift(),a=e[o]||[],u=void 0;for(u=0;u<a.length;u++)a[u].f.apply(a[u].c,r);for(a=e.all||[],r.unshift(o),u=0;u<a.length;u++)a[u].f.apply(a[u].c,r)}}})}function R(e,t){for(t=e="";e++<36;t+=51*e&52?(15^e?8^Math.random()*(20^e?16:4):4).toString(16):"-");return t}function E(e){Ae(this,E),this.collection=e,this.data=null}function k(e){return e.replace(ke,"\\$1")}function I(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t?0:null===e?-1:null===t?1:t>e?-1:e>t?1:0)}function M(e,t,n){return e.splice(t,0,n),e}function j(e,t){return e.splice(t,1),e}function P(e,t,n){for(var r=0,i=e.length,o=void 0,a=void 0;i>r;){if(a=(r+i)/2|0,o=I(t,e[a],n),0===o)return{found:!0,index:a};0>o?i=a:r=a+1}return{found:!1,index:i}}function S(e,t){if(Ae(this,S),e||(e=[]),!fe(e))throw new Error("fieldList must be an array.");t||(t={}),this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}function L(e,n){var r=this;Ae(r,L),t(e)&&!fe(e)&&(n=e,e=[]),e||(e=[]),n||(n={}),m(r,n),r._listeners={};var i=r.recordId();r.index=new S([i],{hashCode:function(e){return u(e,i)}}),r.indexes={},r.autoPks={},e.forEach(function(e){e=r.mapper?r.mapper.createRecord(e):e,r.index.insertRecord(e),e&&o(e.on)&&e.on("all",r._onRecordEvent,r)})}function F(e,t,n){n||(n={});var r=n.getRelation||function(){return t},i=n.localField;if(!i)throw new Error("localField is required");var o=n.foreignKey||n.localKey;if(!o)throw new Error("foreignKey is required");return e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="belongsTo",n.name=e.name,n.relation=ce(t)?t:t.name,n.getRelation=r,e.relationList.push(n),e.relationFields.push(i),e}function N(e,t){return function(n){return F(n,e,t)}}function D(e){var t=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];return e=e||{},function(n){return l(e,function(e,r){(void 0===n[r]||t)&&(n[r]=x(e))}),n}}function K(e,t,n){n||(n={});var r=n.getRelation||function(){return t},i=n.localField;if(!i)throw new Error("localField is required");var o=n.foreignKey,a=n.localKeys,u=n.foreignKeys;if(!o&&!a&&!u)throw new Error("one of (foreignKey, localKeys, foreignKeys) is required");return e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="hasMany",n.name=e.name,n.relation=ce(t)?t:t.name,n.getRelation=r,e.relationList.push(n),e.relationFields.push(i),e}function q(e,t){return function(n){return K(n,e,t)}}function U(e,t,n){n||(n={});var r=n.getRelation||function(){return t},i=n.localField;if(!i)throw new Error("localField is required");var o=n.foreignKey;if(!o)throw new Error("foreignKey is required");return e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="hasOne",n.name=e.name,n.relation=ce(t)?t:t.name,n.getRelation=r,e.relationList.push(n),e.relationFields.push(i),e}function T(e,t){return function(n){return U(n,e,t)}}function J(e,t,n){var r={enumerable:void 0!==n.enumerable?n.enumerable:!0};return r.get=function(){return this._get("props."+t)},r.set=function(e){var r=this,i=this._get,o=this._set,a=this._unset;return n.track&&!i("creating")&&!function(){var n=i("changing"),s=i("previous."+t),f=i("props."+t),c=i("changed");n||(c=[]);var l=c.indexOf(t);f!==e&&-1===l&&c.push(t),s!==e?o("changes."+t,e):(a("changes."+t),l>=0&&c.splice(l,1)),c.length||(n=!1,a("changing"),a("changed"),i("eventId")&&(clearTimeout(i("eventId")),a("eventId"))),!n&&c.length&&(o("changed",c),o("changing",!0),o("eventId",setTimeout(function(){if(a("changed"),a("eventId"),a("changing"),!i("silent")){var e=void 0;for(e=0;e<c.length;e++)r.emit("change:"+c[e],r,u(r,c[e]));r.emit("change",r,i("changes"))}a("silent")},0)))}(),o("props."+t,e),e},n.get&&(r.get?!function(){var e=r.get;r.get=function(){return n.get.call(this,e)}}():r.get=n.get),n.set&&(r.set?!function(){var e=r.set;r.set=function(t){return n.set.call(this,t,e)}}():r.set=n.set),r}function $(e){return e||(e={}),function(t){return t.schema||(t.schema={}),D(t.schema,e),l(e,function(e,n){var r=J(t,n,e);r.writable||Object.defineProperty(t.prototype,n,r)}),t}}function B(e,t,n){return n||(n={}),n.op=Pe,function(r){r.getAdapters()[e]=t,(n===!0||n.default)&&(r.defaultAdapter=e)}}function G(e,t){var n=this;Ae(n,G),e||(e={}),t||(t={});var r={};Object.defineProperties(n,{_get:{value:function(e){return u(r,e)}},_set:{value:function(e,t){return c(r,e,t)}}}),n._set("creating",!0),t.noValidate&&n._set("noValidate",!0),m(n,e),n._set("creating"),n._set("changes",{}),n._set("noValidate"),n._set("previous",x(e))}function V(e){e||(e={}),m(this,e)}function z(e){var t=this;Ae(t,z),e||(e={}),m(t,e),m(t,x(Ye)),t.schema instanceof V||(t.schema=new V(t.schema)),de(t.RecordClass)&&(t.RecordClass=G.extend()),t.RecordClass&&(t.RecordClass.Mapper=t)}function H(e){var t=this;Ae(t,H),e||(e={}),m(t,e),m(t,rt),t._adapters={},t._mappers={},t.mapperDefaults=t.mapperDefaults||{},t.MapperClass=t.MapperClass||z}var Q={};Q.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},Q.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};var Z=1/0,W=1.7976931348623157e308,X="[object Boolean]",Y="[object Date]",ee="[object Function]",te="[object Number]",ne="[object Object]",re="[object RegExp]",ie="[object String]",oe=Object.prototype.toString,ae=void 0;try{ae=!!window}catch(e){ae=!1}var ue=function(e){return oe.call(e)},se=function(e){if(!e)return 0===e?e:0;if(e=+e,e===Z||e===-Z){var t=0>e?-1:1;return t*W}var n=e%1;return e===e?n?e-n:e:0},fe=Array.isArray,ce=function(e){return"string"==typeof e||e&&"object"===("undefined"==typeof e?"undefined":Q.typeof(e))&&ue(e)===ie},le=function(e){return null===e},de=function(e){return void 0===e},pe=function(e){return e&&"object"===("undefined"==typeof e?"undefined":Q.typeof(e))&&ue(e)===Y},he=function(e){var t="undefined"==typeof e?"undefined":Q.typeof(e);return"number"===t||e&&"object"===t&&ue(e)===te},ve=function(e){return ue(e)===te&&e==se(e)},ge=/^(.+)\.(.+)$/,me=JSON.stringify,ye=/\s+/,be=/[^A-Za-z]/g,xe=/(\w)(\w*)/g,Ae=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},we=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":Q.typeof(t))&&"function"!=typeof t?e:t},_e=function(e,t){l(t,function(e,n){t[n]={value:e}}),Object.defineProperties(e,t)},Oe=function(e,t){var n=this,r=void 0;return e||(e={}),t||(t={}),e.hasOwnProperty("constructor")?(r=e.constructor,delete e.constructor):r=function(){Ae(this,r);for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var i=we(this,(r.__super__||Object.getPrototypeOf(r)).apply(this,t));return i},r.prototype=Object.create(n&&n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(r,n):t.strictEs6Class?r.__proto__=n:l(n,function(e,t){r[t]=e}),Object.defineProperty(r,"__super__",{configurable:!0,value:n}),_e(r.prototype,e),m(r,t),r},Ce=function(e){var t=e.constructor;return t.__super__||Object.getPrototypeOf(t)||t.__proto__},Re=Object.freeze({get isBrowser(){return ae},isArray:fe,isObject:t,isRegExp:r,isString:ce,isNull:le,isUndefined:de,isDate:pe,isNumber:he,isInteger:ve,isBoolean:i,isFunction:o,isSorN:a,get:u,unset:s,set:c,forOwn:l,deepMixIn:d,resolve:p,reject:h,_:v,intersection:g,fillIn:m,isBlacklisted:y,fromJson:b,toJson:me,copy:x,pascalCase:_,camelCase:O,eventify:C,uuid:R,classCallCheck:Ae,possibleConstructorReturn:we,addHiddenPropsToTarget:_e,extend:Oe,getSuper:Ce});E.extend=Oe;var Ee={skip:"",offset:"",where:"",limit:"",orderBy:"",sort:""},ke=/([.*+?^=!:${}()|[\]\/\\])/g,Ie=/%/g,Me=/_/g;E.ops={"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"!==":function(e,t){return e!==t},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},isectEmpty:function(e,t){return!g(e||[],t||[]).length},isectNotEmpty:function(e,t){return g(e||[],t||[]).length},in:function(e,t){return-1!==t.indexOf(e)},notIn:function(e,t){return-1===t.indexOf(e)},contains:function(e,t){return-1!==(e||[]).indexOf(t)},notContains:function(e,t){return-1===(e||[]).indexOf(t)}},_e(E.prototype,{compare:function(e,t,n,r){var i=e[t],o=u(n,i[0]),a=u(r,i[0]);return o&&ce(o)&&(o=o.toUpperCase()),a&&ce(a)&&(a=a.toUpperCase()),n||(n=null),r||(r=null),"DESC"===i[1]?o>a?-1:a>o?1:t<e.length-1?this.compare(e,t+1,n,r):0:a>o?-1:o>a?1:t<e.length-1?this.compare(e,t+1,n,r):0},evaluate:function(e,t,n){return E.ops[t]?E.ops[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0},like:function(e,t){return new RegExp("^"+k(e).replace(Ie,".*").replace(Me,".")+"$",t)},getData:function(){return this.data||(this.data=this.collection.index.getAll()),this.data},between:function(e,t,n){n||(n={});var r=this.collection,i=n.index?r.indexes[n.index]:r.index;if(this.data)throw new Error("Cannot access index after first operation!");return this.data=i.between(e,t,n),this},get:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=arguments[1];if(t||(t={}),this.data)throw new Error("Cannot access index after first operation!");if(e&&!fe(e)&&(e=[e]),!e.length)return this.getData(),this;var n=this.collection,r=t.index?n.indexes[t.index]:n.index;return this.data=r.get(e),this},getAll:function(){var e=this,n={};if(this.data)throw new Error("Cannot access index after first operation!");for(var r=arguments.length,i=Array(r),o=0;r>o;o++)i[o]=arguments[o];if(!i.length||1===i.length&&t(i[0]))return this.getData(),this;i.length&&t(i[i.length-1])&&(n=i[i.length-1],i.pop());var a=this.collection,u=n.index?a.indexes[n.index]:a.index;return this.data=[],i.forEach(function(t){e.data=e.data.concat(u.get(t))}),this},filter:function(e,n){var r=this;return e||(e={}),r.getData(),t(e)?!function(){var n={};t(e.where)&&(n=e.where),l(e,function(e,t){t in Ee||t in n||(n[t]={"==":e})});var i=[],o=[],a=[];l(n,function(e,n){t(e)||(e={"==":e}),l(e,function(e,t){i.push(n),o.push(t),a.push(e)})}),i.length&&!function(){var e=void 0,t=i.length;r.data=r.data.filter(function(n){var s=!0,f=!0;for(e=0;t>e;e++){var c=o[e],l="|"===c.charAt(0);c=l?c.substr(1):c;var d=r.evaluate(u(n,i[e]),c,a[e]);void 0!==d&&(f=s?d:l?f||d:f&&d),s=!1}return f})}();var s=e.orderBy||e.sort;ce(s)&&(s=[[s,"ASC"]]),fe(s)||(s=null),s&&!function(){var e=0;s.forEach(function(e,t){ce(e)&&(s[t]=[e,"ASC"])}),r.data.sort(function(t,n){return r.compare(s,e,t,n)})}(),he(e.skip)?r.skip(e.skip):he(e.offset)&&r.skip(e.offset),he(e.limit)&&r.limit(e.limit)}():o(e)&&(r.data=r.data.filter(e,n)),r},skip:function(e){if(!he(e))throw new TypeError("skip: Expected number but found "+("undefined"==typeof e?"undefined":Q.typeof(e))+"!");var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this},limit:function(e){if(!he(e))throw new TypeError("limit: Expected number but found "+("undefined"==typeof e?"undefined":Q.typeof(e))+"!");var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},forEach:function(e,t){return this.getData().forEach(e,t),this},map:function(e,t){return this.data=this.getData().map(e,t),this},mapCall:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return this.data=this.getData().map(function(t){return t[e].apply(t,n)}),this},run:function(){var e=this.data;return this.data=null,e}});var je={">":1,">=":1,"<":1,"<=":1};_e(S.prototype,{set:function(e,t){fe(e)||(e=[e]);var n=e.shift()||null,r=P(this.keys,n);if(0===e.length)if(r.found){var i=P(this.values[r.index],t,this.hashCode);i.found||M(this.values[r.index],i.index,t)}else M(this.keys,r.index,n),M(this.values,r.index,[t]);else if(r.found)this.values[r.index].set(e,t);else{M(this.keys,r.index,n);var o=new S([],{hashCode:this.hashCode});o.set(e,t),M(this.values,r.index,o)}},get:function(e){fe(e)||(e=[e]);var t=e.shift()||null,n=P(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index]:[]:n.found?this.values[n.index].get(e):[]},getAll:function(){var e=[];return this.values.forEach(function(t){e=t.isIndex?e.concat(t.getAll()):e.concat(t)}),e},visitAll:function(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})},query:function(e){var t=void 0,n=void 0;if(e[">"]?(t=e[">"],e.leftInclusive=!1):e[">="]&&(t=e[">="],e.leftInclusive=!0),e["<"]?(n=e["<"],e.rightInclusive=!1):e["<="]&&(n=e["<="],e.rightInclusive=!0),t.length!==n.length)throw new Error("Key arrays must be same length");var r={};return l(e,function(e,t){je[t]||(r[t]=e)}),this.between(t,n,r)},between:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];fe(e)||(e=[e]),fe(t)||(t=[t]),m(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,n);return n.limit?r.slice(n.offset,n.limit+n.offset):r.slice(n.offset)},_between:function(e,t,n){var r=[],i=e.shift(),o=t.shift(),a=void 0;if(a=void 0!==i?P(this.keys,i):{found:!1,index:0},0===e.length){a.found&&n.leftInclusive===!1&&(a.index+=1);for(var u=a.index;u<this.keys.length;u+=1){if(void 0!==o)if(n.rightInclusive){if(this.keys[u]>o)break}else if(this.keys[u]>=o)break;if(r=this.values[u].isIndex?r.concat(this.values[u].getAll()):r.concat(this.values[u]),n.limit&&r.length>=n.limit+n.offset)break}}else for(var u=a.index;u<this.keys.length;u+=1){var s=this.keys[u];if(s>o)break;if(r=this.values[u].isIndex?s===i?r.concat(this.values[u]._between(x(e),t.map(function(){}),n)):s===o?r.concat(this.values[u]._between(e.map(function(){}),x(t),n)):r.concat(this.values[u].getAll()):r.concat(this.values[u]),n.limit&&r.length>=n.limit+n.offset)break}return n.limit?r.slice(0,n.limit+n.offset):r},peek:function(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},remove:function(e,t){fe(e)||(e=[e]);var n=e.shift(),r=P(this.keys,n);if(0===e.length){if(r.found){var i=P(this.values[r.index],t,this.hashCode);i.found&&(j(this.values[r.index],i.index),0===this.values[r.index].length&&(j(this.keys,r.index),j(this.values,r.index)))}}else r.found&&this.values[r.index].delete(e,t)},clear:function(){this.keys=[],this.values=[]},insertRecord:function(e){var t=this.fieldList.map(function(t){return o(t)?t(e)||null:e[t]||null});this.set(t,e)},removeRecord:function(e){var t=this,n=void 0;return this.values.forEach(function(r,i){if(r.isIndex){if(r.removeRecord(e))return 0===r.keys.length&&(j(t.keys,i),j(t.values,i)),n=!0,!1}else{var o=P(r,e,t.hashCode);if(o.found)return j(r,o.index),0===r.length&&(j(t.keys,i),j(t.values,i)),n=!0,!1}}),n?e:void 0},updateRecord:function(e){this.removeRecord(e),this.insertRecord(e)}}),L.extend=Oe,_e(L.prototype,{_onRecordEvent:function(){this.emit.apply(this,arguments)},add:function(e,t){var n=this;t||(t={}),v(n,t),e=n.beforeAdd(e,t)||e;var r=!1,i=n.recordId();fe(e)||(e=[e],r=!0),e=e.map(function(e){var r=n.recordId(e),u=!1;if(!a(r)){if(!t.autoPk)throw new TypeError(i+": Expected string or number, found "+("undefined"==typeof r?"undefined":Q.typeof(r))+"!");r=R(),c(e,i,r),u=!0}var s=n.get(r);if(e===s)return s;if(s){var f=t.onConflict||n.onConflict;"merge"===f?d(s,e):"replace"===f&&(l(s,function(t,n){n===i||e.hasOwnProperty(n)||delete s[n]}),s.set(e)),e=s,n.updateIndexes(e)}else e=n.mapper?n.mapper.createRecord(e):e,n.index.insertRecord(e),l(n.indexes,function(t,n){t.insertRecord(e)}),e&&o(e.on)&&(e.on("all",n._onRecordEvent,n),n.emit("add",e));return u&&(n.autoPks[r]=e),e});var u=r?e.length?e[0]:void 0:e;return n.afterAdd(e,t,u)||u},afterAdd:function(){},afterRemove:function(){},afterRemoveAll:function(){},beforeAdd:function(){},beforeRemove:function(){},beforeRemoveAll:function(){},between:function(e,t,n){return this.query().between(e,t,n).run()},createIndex:function(e,t,n){var r=this;ce(e)&&void 0===t&&(t=[e]),n||(n={}),n.hashCode=n.hashCode||function(e){return r.recordId(e)};var i=r.indexes[e]=new S(t,n);return r.index.visitAll(i.insertRecord,i),r},filter:function(e,t){return this.query().filter(e,t).run()},forEach:function(e,t){this.index.visitAll(e,t)},get:function(e){var t=this.query().get(e).run();return t.length?t[0]:void 0},getAll:function(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},getAutoPkItems:function(){var e=this;return e.getAll().filter(function(t){return e.autoPks[e.recordId(t)]})},limit:function(e){return this.query().limit(e).run()},map:function(e,t){var n=[];return this.index.visitAll(function(r){n.push(e.call(t,r))}),n},mapCall:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=[];return this.index.visitAll(function(t){i.push(t[e].apply(t,n))}),i},recordId:function(e){if(e)return u(e,this.recordId());var t=this;return t.mapper?t.mapper.idAttribute:t.idAttribute||"id"},query:function(){return new E(this)},reduce:function(e,t){var n=this.getAll();return n.reduce(e,t)},remove:function(e,t){var n=this;t||(t={}),n.beforeRemove(e,t);var r=n.get(e);return r&&(delete n.autoPks[e],n.index.removeRecord(r),l(n.indexes,function(e,t){e.removeRecord(r)}),r&&o(r.off)&&(r.off("all",n._onRecordEvent,n),n.emit("remove",r))),n.afterRemove(e,t,r)||r},removeAll:function(e,t){var n=this;t||(t={}),n.beforeRemoveAll(e,t);var r=n.filter(e);return r.forEach(function(e){n.remove(n.recordId(e))}),n.afterRemoveAll(e,t,r)||r},skip:function(e){return this.query().skip(e).run()},toJSON:function(e){return this.mapCall("toJSON",e)},updateIndex:function(e,t){t||(t={});var n=t.index?this.indexes[t.index]:this.index;n.updateRecord(e)},updateIndexes:function(e){var t=this;t.index.updateRecord(e),l(t.indexes,function(t,n){t.updateRecord(e)})}}),C(L.prototype,function(){return this._listeners},function(e){this._listeners=e});var Pe="registerAdapter";G.extend=Oe,_e(G.prototype,{_mapper:function(){return this.constructor.Mapper},get:function(e){return u(this,e)},set:function(e,n,r){var i=this;t(e)&&(r=n),r||(r={}),r.silent&&i._set("silent",!0),c(i,e,n),i._get("eventId")||i._set("silent")},unset:function(e,t){this.set(e,void 0,t)},hashCode:function(){var e=this;return u(e,e._mapper().idAttribute)},changes:function(e){var t=this;return e?t._get("changes."+e):t._get("changes")},hasChanges:function(){return!!(this._get("changed")||[]).length},commit:function(){var e=this;return e._set("changed"),e._set("changes",{}),e._set("previous",x(e)),e},previous:function(e){var t=this;return e?t._get("previous."+e):t._get("previous")},revert:function(e){var t=this,n=t._get("previous")||{};return e||(e={}),e.preserve||(e.preserve=[]),l(t,function(r,i){i!==t._mapper().idAttribute&&!n.hasOwnProperty(i)&&t.hasOwnProperty(i)&&-1===e.preserve.indexOf(i)&&delete t[i]}),l(n,function(n,r){-1===e.preserve.indexOf(r)&&(t[r]=n)}),t.commit(),t},schema:function(e){var t=this._mapper().schema;return e?t[e]:t},create:function(e){return this._mapper().create(this,e)},beforeSave:function(){},save:function(e){var t=void 0,n=void 0,r=this,i=r._mapper();return e||(e={}),v(r,e),n=e.adapter=r.getAdapterName(e),t=e.op="beforeSave",p(r[t](e)).then(function(){return t=e.op="save",i.dbg(t,r,e),r.getAdapter(n)[t](i,r,e)}).then(function(n){return t=e.op="afterSave",p(r[t](n,e)).then(function(t){return n=t||n,e.raw?(r.set(n.data),n.data=r):r.set(n),i.end(n,e)})})},afterSave:function(){},beforeLoadRelations:function(){},loadRelations:function(e,t){var n=void 0,r=this,i=r._mapper(),s=i.relationList||[];return e||(e=[]),t||(t={}),v(i,t),t.adapter=i.getAdapterName(t),n=t.op="beforeLoadRelations",p(r[n](e,t)).then(function(){return ce(e)&&(e=[e]),n=t.op="loadRelations",i.dbg(n,r,e,t),Promise.all(s.map(function(e){if(o(e.load))return e.load(i,e,r,t);var n=void 0;if("hasMany"===e.type&&e.foreignKey)n=e.getRelation().findAll(Q.defineProperty({},e.foreignKey,u(r,i.idAttribute)),t);else if(e.foreignKey){var s=u(r,e.foreignKey);a(s)&&(n=e.getRelation().find(s,t))}else e.localKeys?n=e.getRelation().findAll(Q.defineProperty({},e.getRelation().idAttribute,{in:u(r,e.localKeys)}),t):e.foreignKeys&&(n=e.getRelation().findAll(Q.defineProperty({},e.getRelation().idAttribute,{contains:u(r,i.idAttribute)}),t));return n&&(n=n.then(function(n){t.raw&&(n=n.data),c(r,e.localField,"hasOne"===e.type?n.length?n[0]:void 0:n)})),n}))}).then(function(){return n=t.op="afterLoadRelations",p(r[n](e,t)).then(function(){return r})})},afterLoadRelations:function(){},destroy:function(e){var t=this._mapper();return t.destroy(u(this,t.idAttribute),e)},toJSON:function(e){return this._mapper().toJSON(this,e)}}),C(G.prototype,function(){return this._get("events")},function(e){this._set("events",e)});var Se={array:fe,boolean:i,integer:ve,null:le,number:he,object:t,string:ce},Le={},Fe={},Ne=function(e,t){var n="";return e&&(n+=he(e)?"["+e+"]":t?"."+e:""+e),n},De=function(e){e||(e={});var t="",n=e.path||[];return n.forEach(function(e){t+=Ne(e,t)}),t+=Ne(e.prop,t)},Ke=function(e,t,n){return{expected:t,actual:""+e,path:De(n)}},qe=function(e,t,n,r){r.push(Ke(e,t,n))},Ue=function(e,t,n,r){var i=n[e];return t.length>i?Ke(t.length,"length no more than "+i,r):void 0},Te=function(e,t,n,r){var i=n[e];return t.length<i?Ke(t.length,"length no less than "+i,r):void 0},Je=function(e,t,n,r){return!de(n[e])&&Fe[e](t,n,r)},$e=function(e,t,n,r){var i=[];return e.forEach(function(e){i=i.concat(Je(e,t,n,r)||[])}),i.length?i:void 0},Be=["enum","type","allOf","anyOf","oneOf","not"],Ge=["items","maxItems","minItems","uniqueItems"],Ve=["multipleOf","maximum","minimum"],ze=["maxProperties","minProperties","required","properties","dependencies"],He=["maxLength","minLength","pattern"],Qe=function(e,t,n){return $e(Be,e,t,n)},Ze=function e(n,r,i){var a=[];i||(i={});var u=void 0,s=i.prop;if(!de(r)){if(!t(r))throw new Error('Invalid schema at path: "'+i.path+'"');return de(i.path)&&(i.path=[]),de(i.prop)||(u=!0,i.path.push(i.prop),i.prop=void 0),r.extends&&(a=o(r.extends.validate)?a.concat(r.extends.validate(n,i)||[]):a.concat(e(n,r.extends,i)||[])),de(n)?(r.required===!0&&qe(n,"a value",i,a),u&&(i.path.pop(),i.prop=s),a.length?a:void 0):(a=a.concat(Qe(n,r,i)||[]),u&&(i.path.pop(),i.prop=s),a.length?a:void 0)}};m(Fe,{allOf:function(e,t,n){var r=[];return t.allOf.forEach(function(t){r=r.concat(Ze(e,t,n)||[])}),r.length?void 0:r},anyOf:function(e,t,n){var r=!1,i=[];return t.anyOf.forEach(function(t){var o=Ze(e,t,n);o?i=i.concat(o):r=!0}),r?void 0:i},dependencies:function(e,t,n){},enum:function(e,t,n){var r=t.enum;return-1===r.indexOf(e)?Ke(e,"one of ("+r.join(", ")+")",n):void 0},items:function e(t,n,r){r||(r={});for(var e=n.items,i=[],o=fe(e),a=t.length,u=0;a>u;u++)o&&(e=n.items[u]),r.prop=u,i=i.concat(Ze(t[u],e,r)||[]);return i.length?i:void 0},maximum:function e(t,n,r){var e=n.maximum,i=n.exclusiveMaximum;return("undefined"==typeof t?"undefined":Q.typeof(t))===("undefined"==typeof e?"undefined":Q.typeof(e))&&(i?t>e:t>=e)?Ke(t,"no more than "+e,r):void 0},maxItems:function(e,t,n){return Ue("maxItems",e,t,n)},maxLength:function(e,t,n){return Ue("maxLength",e,t,n)},maxProperties:function e(t,n,r){var e=n.maxProperties,i=Object.keys(t).length;return i>e?Ke(i,"no more than "+e+" properties",r):void 0},minimum:function e(t,n,r){var e=n.minimum,i=n.exclusiveMinimum;return("undefined"==typeof t?"undefined":Q.typeof(t))===("undefined"==typeof e?"undefined":Q.typeof(e))&&(i?e>t:e>=t)?Ke(t,"no less than "+e,r):void 0},minItems:function(e,t,n){return Te("minItems",e,t,n)},minLength:function(e,t,n){return Te("minLength",e,t,n)},minProperties:function e(t,n,r){var e=n.minProperties,i=Object.keys(t).length;return e>i?Ke(i,"no more than "+e+" properties",r):void 0},multipleOf:function(e,t,n){},not:function(e,t,n){return Ze(e,t.not,n)?void 0:Ke("succeeded","should have failed",n)},oneOf:function(e,t,n){var r=!1,i=[];return t.oneOf.forEach(function(t){var o=Ze(e,t,n);if(o)i=i.concat(o);else{if(r)return i=[Ke("valid against more than one","valid against only one",n)],r=!1,!1;r=!0}}),r?void 0:i},pattern:function e(t,n,r){var e=n.pattern;return ce(t)&&!t.match(e)?Ke(t,e,r):void 0},properties:function e(n,r,i){i||(i={});var o=de(r.additionalProperties)?!0:r.additionalProperties,a={},e=r.properties||{},u=r.patternProperties||{},s=[];l(n,function(e,t){a[t]=void 0}),l(e||{},function(e,t){de(n[t])&&!de(e.default)&&(n[t]=x(e.default)),i.prop=t,s=s.concat(Ze(n[t],e,i)||[]),delete a[t]}),l(u,function(e,t){l(a,function(r,o){o.match(t)&&(i.prop=o,s=s.concat(Ze(n[o],e,i)||[]),delete a[o])})});var f=Object.keys(a);return o===!1?f.length&&qe("extra fields: "+f.join(", "),"no extra fields",i,s):t(o)&&f.forEach(function(e){i.prop=e,s=s.concat(Ze(n[e],o,i)||[])}),s.length?s:void 0},required:function e(t,n,r){var e=n.required,i=[];return r.existingOnly||e.forEach(function(e){if(de(u(t,e))){var n=r.prop;r.prop=e,qe(void 0,"a value",r,i),r.prop=n}}),i.length?i:void 0},type:function e(t,n,r){var e=n.type,i=void 0;if(ce(e)&&(e=[e]),e.forEach(function(e){return Se[e](t,n,r)?(i=e,!1):void 0}),!i)return Ke(t?"undefined"==typeof t?"undefined":Q.typeof(t):""+t,"one of ("+e.join(", ")+")",r);var o=Le[i];return o?o(t,n,r):void 0},uniqueItems:function(e,t,n){if(e&&e.length&&t.uniqueItems){var r=e.length,i=void 0,o=void 0,a=void 0;for(o=r-1;o>0;o--)for(i=e[o],a=o-1;a>=0;a--)if(i===e[a])return Ke(i,"no duplicates",n)}}}),m(Le,{array:function(e,t,n){return $e(Ge,e,t,n)},integer:function(e,t,n){return Le.numeric(e,t,n)},number:function(e,t,n){return Le.numeric(e,t,n)},numeric:function(e,t,n){return $e(Ve,e,t,n)},object:function(e,t,n){return $e(ze,e,t,n)},string:function(e,t,n){return $e(He,e,t,n)}}),V.prototype.validate=function(e,t){return Ze(e,this,t)};var We=p,Xe=function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var r=this,i=t.pop();r.dbg.apply(r,[i.op].concat(t)),(i.notify||void 0===i.notify&&r.notify)&&setTimeout(function(){r.emit.apply(r,[i.op].concat(t))})},Ye={_adapters:{},_listeners:null,defaultAdapter:"http",debug:!1,idAttribute:"id",notify:!0,raw:!1,RecordClass:void 0,schema:{},upsert:!0};_e(z.prototype,{end:function(e,t){var n=this;t.raw&&v(t,e);var r=t.raw?e.data:e;return r=fe(r)?r.map(function(e){return n.createRecord(e)}):n.createRecord(r),t.raw?e.data=r:e=r,t.notify&&setTimeout(function(){n.emit(t.op,e,t)}),e},createRecord:function(e,t){var n=this.RecordClass;return n?e instanceof n?e:new n(e,t):e},is:function(e){var t=this.RecordClass;return t?e instanceof t:!1},toJSON:function(e,t){var n=this;t||(t={});var r=e;return n.is(e)&&(r=x(e),n&&n.relationList&&t.with&&(ce(t.with)&&(t.with=[t.with]),n.relationList.forEach(function(n){var i=void 0;-1!==t.with.indexOf(n.relation)?i=n.relation:-1!==t.with.indexOf(n.localField)&&(i=n.localField),i&&!function(){var o={with:t.with.slice()};o.with.splice(o.with.indexOf(i),1),o.with.forEach(function(e,t){e&&0===e.indexOf(i)&&e.length>=i.length&&"."===e[i.length]?o.with[t]=e.substr(i.length+1):o.with[t]=""});var a=u(e,n.localField);a&&(fe(a)?c(r,n.localField,a.map(function(e){return n.getRelation().toJSON(e,o)})):c(r,n.localField,n.getRelation().toJSON(a,o)))}()}))),r},getAdapter:function(e){var t=this;t.dbg("getAdapter","name:",e);var n=t.getAdapterName(e);if(!n)throw new ReferenceError(n+" not found!");return t.getAdapters()[n]},getAdapterName:function(e){return e||(e={}),ce(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},getAdapters:function(){return this._adapters},getSchema:function(){return this.schema},beforeCreate:Xe,checkUpsertCreate:function(e,t){var n=this;return(t.upsert||void 0===t.upsert&&n.upsert)&&u(e,n.idAttribute)},create:function(e,t){var n=void 0,r=void 0,i=this;return e||(e={}),t||(t={}),i.checkUpsertCreate(e,t)?i.update(u(e,i.idAttribute),e,t):(v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeCreate",We(i[n](e,t)).then(function(o){e=o||e,n=t.op="create";var a=i.toJSON(e,t);return i.dbg(n,a,t),We(i.getAdapter(r)[n](i,a,t))}).then(function(e){return n=t.op="afterCreate",We(i[n](e,t)).then(function(n){return e=n||e,i.end(e,t)})}))},afterCreate:Xe,beforeCreateMany:Xe,checkUpsertCreateMany:function(e,t){var n=this;return t.upsert||void 0===t.upsert&&n.upsert?e.reduce(function(e,t){return e&&u(t,n.idAttribute)},!0):void 0},createMany:function(e,t){var n=void 0,r=void 0,i=this;return e||(e=[]),t||(t={}),i.checkUpsertCreateMany(e,t)?i.updateMany(e,t):(v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeCreateMany",We(i[n](e,t)).then(function(o){e=o||e,n=t.op="createMany";var a=e.map(function(e){return i.toJSON(e,t)});return i.dbg(n,a,t),We(i.getAdapter(r)[n](i,a,t))}).then(function(e){return n=t.op="afterCreateMany",We(i[n](e,t)).then(function(n){
return e=n||e,i.end(e,t)})}))},afterCreateMany:Xe,beforeFind:Xe,find:function(e,t){var n=void 0,r=void 0,i=this;return t||(t={}),v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeFind",We(i[n](e,t)).then(function(o){return e=void 0===o?e:o,n=t.op="find",i.dbg(n,e,t),We(i.getAdapter(r)[n](i,e,t))}).then(function(e){return n=t.op="afterFind",We(i[n](e,t)).then(function(n){return e=n||e,i.end(e,t)})})},afterFind:Xe,beforeFindAll:Xe,findAll:function(e,t){var n=void 0,r=void 0,i=this;return e||(e={}),t||(t={}),v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeFindAll",We(i[n](e,t)).then(function(o){return e=o||e,n=t.op="findAll",i.dbg(n,e,t),We(i.getAdapter(r)[n](i,e,t))}).then(function(r){return n=t.op="afterFindAll",We(i[n](r,e,t)).then(function(e){return r=e||r,i.end(r,t)})})},afterFindAll:Xe,beforeUpdate:Xe,update:function(e,t,n){var r=void 0,i=void 0,o=this;return t||(t={}),n||(n={}),v(o,n),i=n.adapter=o.getAdapterName(n),r=n.op="beforeUpdate",We(o[r](e,t,n)).then(function(a){t=a||t,r=n.op="update";var u=o.toJSON(t,n);return o.dbg(r,e,u,n),We(o.getAdapter(i)[r](o,e,u,n))}).then(function(t){return r=n.op="afterUpdate",We(o[r](e,t,n)).then(function(e){return t=e||t,o.end(t,n)})})},afterUpdate:Xe,beforeUpdateMany:Xe,updateMany:function(e,t){var n=void 0,r=void 0,i=this;return e||(e=[]),t||(t={}),v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeUpdateMany",We(i[n](e,t)).then(function(o){e=o||e,n=t.op="updateMany";var a=e.map(function(e){return i.toJSON(e,t)});return i.dbg(n,a,t),We(i.getAdapter(r)[n](i,a,t))}).then(function(e){return n=t.op="afterUpdateMany",We(i[n](e,t)).then(function(n){return e=n||e,i.end(e,t)})})},afterUpdateMany:Xe,beforeUpdateAll:Xe,updateAll:function(e,t,n){var r=void 0,i=void 0,o=this;return e||(e={}),t||(t={}),n||(n={}),v(o,n),i=n.adapter=o.getAdapterName(n),r=n.op="beforeUpdateAll",We(o[r](e,t,n)).then(function(a){t=a||t,r=n.op="updateAll";var u=o.toJSON(t,n);return o.dbg(r,e,u,n),We(o.getAdapter(i)[r](o,e,u,n))}).then(function(t){return r=n.op="afterUpdateAll",We(o[r](e,t,n)).then(function(e){return t=e||t,o.end(t,n)})})},afterUpdateAll:Xe,beforeDestroy:Xe,destroy:function(e,t){var n=void 0,r=void 0,i=this;return t||(t={}),v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeDestroy",We(i[n](e,t)).then(function(o){return e=void 0===o?e:o,n=t.op="destroy",i.dbg(n,e,t),We(i.getAdapter(r)[n](i,e,t))}).then(function(e){return n=t.op="afterDestroy",We(i[n](e,t)).then(function(n){return e=n||e,t.raw?(v(t,e),e):e})})},afterDestroy:Xe,beforeDestroyAll:Xe,destroyAll:function(e,t){var n=void 0,r=void 0,i=this;return e||(e={}),t||(t={}),v(i,t),r=t.adapter=i.getAdapterName(t),n=t.op="beforeDestroyAll",We(i[n](e,t)).then(function(o){return e=o||e,n=t.op="destroyAll",i.dbg(n,e,t),We(i.getAdapter(r)[n](i,e,t))}).then(function(r){return n=t.op="afterDestroyAll",We(i[n](r,e,t)).then(function(e){return r=e||r,t.raw?(v(t,r),r):r})})},afterDestroyAll:Xe,log:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var i=e.toUpperCase()+": ("+(this.name||"mapper")+")";if(console[e]){var o;(o=console)[e].apply(o,[i].concat(n))}else{var a;(a=console).log.apply(a,[i].concat(n))}}},dbg:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))},belongsTo:function(e,t){return N(e,t)(this)},hasMany:function(e,t){return q(e,t)(this)},hasOne:function(e,t){return T(e,t)(this)},setSchema:function(e){return $(e)(this)},configure:function(e){return D(e)(this)},registerAdapter:function(e,t,n){return B(e,t,n)(this)}}),z.extend=Oe,C(z.prototype,function(){return this._listeners},function(e){this._listeners=e});var et="belongsTo",tt="hasMany",nt="hasOne",rt={};H.extend=Oe,_e(H.prototype,{defineMapper:function(e,n){var r=this;if(t(e)){if(n=e,!n.name)throw new Error("name is required!");e=n.name}else if(!ce(e))throw new Error("name is required!");n||(n={}),n.name=e,n.relations||(n.relations={});var i=n.MapperClass||r.MapperClass;delete n.MapperClass,m(n,r.mapperDefaults);var o=r._mappers[e]=new i(n);return o.name=e,o._adapters=r.getAdapters(),l(o.relations,function(e,n){l(e,function(e,i){t(e)&&(e=[e]),e.forEach(function(e){e.getRelation=function(){return r.getMapper(i)};var t=r._mappers[i]||i;n===et?o.belongsTo(t,e):n===nt?o.hasOne(t,e):n===tt&&o.hasMany(t,e)})})}),o},getAdapters:function(){return this._adapters},getMapper:function(e){var t=this._mappers[e];if(!t)throw new ReferenceError(e+" is not a registered mapper!");return t},registerAdapter:function(e,t,n){B(e,t,n)(this)}});var it="belongsTo",ot="hasMany",at="hasOne",ut=L.extend({constructor:function(e,t){var n=this;if(Ae(n,ut),Ce(n).call(n,e,t),n._added={},!n.datastore)throw new Error("This collection must have a datastore!");return n},add:function(e,n){var r=this,i=r.datastore,o=r.mapper,a=o.relationList||[],s=(new Date).getTime(),f=void 0;return e=Ce(r).prototype.add.call(r,e,n),t(e)&&!fe(e)&&(f=!0,e=[e]),e.forEach(function(e){r._added[r.recordId(e)]=s}),a.length&&e.length&&o.relationList.forEach(function(t){if(t.add!==!1){var n=t.relation,r=i.getMapper(n),a=r.idAttribute,s=t.foreignKey,f=t.localField,l=i.getCollection(n),d=t.type,p=d===it,h=d===ot,v=d===at,g=void 0;e.forEach(function(e){g=u(e,f),g&&!function(){var r=u(e,o.idAttribute);if(h)g=g.map(function(e){return e!==l.get(u(e,a))&&(s&&c(e,s,r),e=l.add(n,e)),e}),t.localKeys&&c(e,t.localKeys,g.map(function(e){return u(e,a)}));else{var i=u(g,a);g!==l.get(i)&&(p?c(e,t.foreignKey,i):v&&c(g,t.foreignKey,r),g=l.add(n,g))}c(e,f,g)}()})}}),f?e[0]:e},remove:function(e,t){var n=this;return delete n._added[e],Ce(n).prototype.remove.call(n,e,t)},removeAll:function(e,t){var n=this,r=Ce(n).prototype.removeAll.call(n,e,t);return r.forEach(function(e){delete n._added[n.recordId(e)]}),r}});ut.extend=Oe;var st={linkRelations:ae},ft=H.extend({constructor:function(e){var t=this;return Ae(t,ft),Ce(t).call(t,e),t.CollectionClass=t.CollectionClass||ut,t._collections={},m(t,st),t},_end:function(e,t,n){return n.raw?(t.data=this.getCollection(e).add(t.data,n),t):t=this.getCollection(e).add(t,n)},create:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).create(t,n).then(function(t){return r._end(e,t,n)})},createMany:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).createMany(t,n).then(function(t){return r._end(e,t,n)})},defineMapper:function(e,t){var n=this,r=Ce(n).prototype.defineMapper.call(n,e,t);r.relationList=r.relationList||[],r.relationList.forEach(function(e){});var i=n._collections[e]=new n.CollectionClass(null,{_added:{},datastore:n,mapper:r});return i.createIndex("addedTimestamps",["$"],{fieldGetter:function(e){return i._added[i.recordId(e)]}}),r},destroy:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).destroy(t,n).then(function(i){return n.raw?i.data=r.getCollection(e).remove(t,n):i=r.getCollection(e).remove(t,n),i})},destroyAll:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).destroyAll(t,n).then(function(i){return n.raw?i.data=r.getCollection(e).removeAll(t,n):i=r.getCollection(e).removeAll(t,n),i})},find:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).find(t,n).then(function(t){return r._end(e,t,n)})},findAll:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).findAll(t,n).then(function(t){return r._end(e,t,n)})},getCollection:function(e){var t=this._collections[e];if(!t)throw new ReferenceError(e+" is not a registered collection!");return t},update:function(e,t,n,r){var i=this;return r||(r={}),m(r,i.modelOpts),i.getMapper(e).update(t,n,r).then(function(t){return i._end(e,t,r)})},updateAll:function(e,t,n,r){var i=this;return r||(r={}),m(r,i.modelOpts),i.getMapper(e).updateAll(t,n,r).then(function(t){return i._end(e,t,r)})},updateMany:function(e,t,n){var r=this;return n||(n={}),m(n,r.modelOpts),r.getMapper(e).updateMany(t,n).then(function(t){return r._end(e,t,n)})}});ft.prototype.defineResource=ft.prototype.defineMapper,ft.extend=Oe;var ct={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"},lt=ft;e.Collection=L,e.Container=H,e.DataStore=ft,e.DS=lt,e.LinkedCollection=ut,e.Mapper=z,e.Query=E,e.Record=G,e.utils=Re,e.version=ct,e.belongsTo=N,e.configure=D,e.hasMany=q,e.hasOne=T,e.setSchema=$,e.registerAdapter=B,e.types=Se,e.typeGroupValidators=Le,e.validationKeywords=Fe,e.validate=Ze,e.Schema=V});
//# sourceMappingURL=dist/js-data.min.map