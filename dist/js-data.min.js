/*!
* js-data
* @version 3.0.0-alpha.2 - Homepage <http://www.js-data.io/>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2015 Jason Dobry
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview Robust framework-agnostic data store.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.JSData={})}(this,function(e){"use strict";function t(e){return"[object Object]"===toString.call(e)||!1}function n(e){return!!e&&"object"===("undefined"==typeof e?"undefined":X.typeof(e))&&e.constructor===Object}function i(e){return"[object RegExp]"===toString.call(e)||!1}function r(e){return"string"==typeof e||e&&"object"===("undefined"==typeof e?"undefined":X.typeof(e))&&"[object String]"===toString.call(e)||!1}function o(e){return e&&"object"===("undefined"==typeof e?"undefined":X.typeof(e))&&"[object Date]"===toString.call(e)||!1}function a(e){var t="undefined"==typeof e?"undefined":X.typeof(e);return"number"===t||e&&"object"===t&&"[object Number]"===toString.call(e)||!1}function u(e){return"[object Boolean]"===toString.call(e)}function s(e){return"function"==typeof e||e&&"[object Function]"===toString.call(e)||!1}function l(e){return r(e)||a(e)}function c(e,t){if(t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(e=e[t],null==e)return;return e[i]}}function f(e,t){for(var n=t.split("."),i=n.pop();t=n.shift();)if(e=e[t],null==e)return;delete e[i]}function h(e,t){if(!t)return e;var n=t.split(".");return n.forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e}function d(e,n,i){if(t(n))p(n,function(t,n){d(e,n,t)});else{var r=te.exec(n);r?h(e,r[1])[r[2]]=i:e[n]=i}}function p(e,t,n){var i=Object.keys(e),r=i.length,o=void 0;for(o=0;r>o;o++)t.call(n,e[i[o]],i[o],e)}function v(e,t){return t&&p(t,function(e,t){var i=this[t];n(e)&&n(i)?v(i,e):this[t]=e},e),e}function g(e){return Promise.resolve(e)}function y(e){return Promise.reject(e)}function m(e,t){for(var n in e){var i=e[n];void 0!==t[n]||s(i)||(t[n]=i)}}function b(e,t){if(!e||!t)return[];var n=[],i=void 0,r=void 0,o=e.length;for(r=0;o>r;r++)i=e[r],-1===n.indexOf(i)&&-1!==t.indexOf(i)&&n.push(i);return n}function k(e,t){p(t,function(t,n){void 0===e[n]&&(e[n]=t)})}function A(e,t){if(!t||!t.length)return!1;for(var n=void 0,i=0;i<t.length;i++)if("[object RegExp]"===Object.prototype.toString.call(t[i])&&t[i].test(e)||t[i]===e)return n=e;return!!n}function x(e){return r(e)?JSON.parse(e):e}function w(e,n,r,a,u){if(n){if(e===n)throw new Error("Cannot copy! Source and destination are identical.");if(r=r||[],a=a||[],t(e)){var s=r.indexOf(e);if(-1!==s)return a[s];r.push(e),a.push(n)}var l=void 0;if(ee(e)){var c=void 0;for(n.length=0,c=0;c<e.length;c++)l=w(e[c],null,r,a,u),t(e[c])&&(r.push(e[c]),a.push(l)),n.push(l)}else{ee(n)?n.length=0:p(n,function(e,t){delete n[t]});for(var f in e)if(e.hasOwnProperty(f)){if(A(f,u))continue;l=w(e[f],null,r,a,u),t(e[f])&&(r.push(e[f]),a.push(l)),n[f]=l}}}else n=e,e&&(ee(e)?n=w(e,[],r,a,u):o(e)?n=new Date(e.getTime()):i(e)?(n=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]),n.lastIndex=e.lastIndex):t(e)&&(n=w(e,Object.create(Object.getPrototypeOf(e)),r,a,u)));return n}function _(e,t,n){return""+t.toUpperCase()+n.toLowerCase()}function j(e){return e.replace(re,"").replace(oe,_)}function O(e){return e.split(ie).map(j).join("")}function E(e){return e=O(e),e?e.charAt(0).toLowerCase()+e.slice(1):e}function C(e,t,n){e=e||this;var i={};t||n||(t=function(){return i},n=function(e){i=e}),Object.defineProperties(e,{on:{value:function(e,i,r){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({f:i,c:r})}},off:{value:function(e,i){var r=t.call(this),o=r[e];if(o)if(i){for(var a=0;a<o.length;a++)if(o[a].f===i){o.splice(a,1);break}}else o.splice(0,o.length);else n.call(this,{})}},emit:{value:function(){for(var e=t.call(this)||{},n=arguments.length,i=Array(n),r=0;n>r;r++)i[r]=arguments[r];var o=i.shift(),a=e[o]||[],u=void 0;for(u=0;u<a.length;u++)a[u].f.apply(a[u].c,i);for(a=e.all||[],i.unshift(o),u=0;u<a.length;u++)a[u].f.apply(a[u].c,i)}}})}function R(e,t){for(t=e="";e++<36;t+=51*e&52?(15^e?8^Math.random()*(20^e?16:4):4).toString(16):"-");return t}function P(e){this.collection=e,this.data=null}function I(e,t,n,i){var o=e[t],a=c(n,o[0]),u=c(i,o[0]);return a&&r(a)&&(a=a.toUpperCase()),u&&r(u)&&(u=u.toUpperCase()),"DESC"===o[1]?a>u?-1:u>a?1:t<e.length-1?I(e,t+1,n,i):0:u>a?-1:a>u?1:t<e.length-1?I(e,t+1,n,i):0}function F(e){return e.replace(se,"\\$1")}function M(e,t){return new RegExp("^"+F(e).replace(le,".*").replace(ce,".")+"$",t)}function S(e,t,n){switch(t){case"==":return e==n;case"===":return e===n;case"!=":return e!=n;case"!==":return e!==n;case">":return e>n;case">=":return e>=n;case"<":return n>e;case"<=":return n>=e;case"isectEmpty":return!b(e||[],n||[]).length;case"isectNotEmpty":return b(e||[],n||[]).length;case"in":return-1!==n.indexOf(e);case"notIn":return-1===n.indexOf(e);case"contains":return-1!==e.indexOf(n);case"notContains":return-1===e.indexOf(n);default:if(0===t.indexOf("like"))return null!==M(n,t.substr(4)).exec(e);if(0===t.indexOf("notLike"))return null===M(n,t.substr(7)).exec(e)}}function L(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t?0:null===e?-1:null===t?1:t>e?-1:e>t?1:0)}function N(e,t,n){return e.splice(t,0,n),e}function D(e,t){return e.splice(t,1),e}function K(e,t,n){for(var i=0,r=e.length,o=void 0,a=void 0;r>i;){if(a=(i+r)/2|0,o=L(t,e[a],n),0===o)return{found:!0,index:a};0>o?r=a:i=a+1}return{found:!1,index:r}}function U(e,t){if(e||(e=[]),!ee(e))throw new Error("fieldList must be an array.");t||(t={}),this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}function q(){var e=this,t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=arguments.length<=1||void 0===arguments[1]?"id":arguments[1];if(!ee(t))throw new TypeError("new Collection([data]): data: Expected array. Found "+("undefined"==typeof t?"undefined":X.typeof(t)));this.idAttribute=n,this.index=new U([n],{hashCode:function(e){return c(e,n)}}),this.indexes={},t.forEach(function(t){e.index.insertRecord(t),t&&s(t.on)&&t.on("all",e._onModelEvent,e)})}function T(e,t){var n=[];return p(e,function(e,i){var r=de[i];if(r){var o=r(e,t);o&&n.push(o)}}),n.length?n:void 0}function $(e){var t=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];return e=e||{},function(n){return p(e,function(e,i){(void 0===n[i]||t)&&(n[i]=w(e))}),n}}function J(e,t,n){var i={enumerable:void 0!==n.enumerable?n.enumerable:!0,configurable:void 0!==n.configurable?n.configurable:!0};return i.get=function(){return this._get("props."+t)},i.set=function(i){var r=this,o=this._get,a=this._set,u=this._unset;if(!o("noValidate")){var s=T(n,i);if(s)throw new Error(s.join(", "))}return n.track&&!o("creating")&&!function(){var e=o("changing"),n=o("previous."+t),s=o("props."+t),l=o("changed");e||(l=[]),s!==i&&l.push(t),n!==i?a("changes."+t,i):u("changes."+t),!e&&l.length&&(a("changed",l),a("changing",!0),a("eventId",setTimeout(function(){u("changed"),u("eventId"),u("changing");var e=void 0;for(e=0;e<l.length;e++)r.emit("change:"+l[e],r,c(r,l[e]));r.emit("change",r,o("changes"))},0)))}(),a("props."+t,i),o("$")&&n.indexed&&e.collection.updateRecord(this,{index:t}),i},n.indexed&&e.createIndex(t),n.get&&(i.get?!function(){var e=i.get;i.get=function(){return n.get.call(this,e)}}():i.get=n.get),n.set&&(i.set?!function(){var e=i.set;i.set=function(t){return n.set.call(this,t,e)}}():i.set=n.set),i}function z(e){return e||(e={}),function(t){return t.dbg(pe,"opts:",e),t.schema||(t.schema={}),$(t.schema,e),p(e,function(e,n){var i=J(t,n,e);i.writable||Object.defineProperty(t.prototype,n,i)}),t}}function B(e,t,n){return n||(n={}),n.op=ve,function(i){i.dbg(ve,"name:",e,"adapter:",t,"opts:",n),i.adapters[e]=t,(n===!0||n.default)&&(i.defaultAdapter=e)}}function V(e,t,n){n||(n={});var i=n.localField=n.localField||t.name.toLowerCase(),r=n.localKey=n.localKey||t.name.toLowerCase()+"_id",o={enumerable:void 0!==n.enumerable?!!n.enumerable:!1,get:function(){if(!this._get("$"))return this._get("links."+i);var e=c(this,r),n=void 0!==e?t.get(e):void 0;return this._set("links."+i,n),n},set:function(e){return this._set("links."+i,e),d(this,r,e[t.idAttribute]),c(this,i)}},a=o.get,u=o.set;return(n.link===!1||void 0===n.link&&!e.linkRelations)&&(delete o.get,delete o.set,o.writable=!0),n.get&&(o.get=function(){var i=this;return n.get(e,t,this,a?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return a.apply(i,t)}:void 0)},delete o.writable),n.set&&(o.set=function(i){var r=this;return n.set(e,t,this,i,u?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return u.apply(r,t)}:void 0)},delete o.writable),o.get&&(o.set||(o.set=function(){})),Object.defineProperty(e.prototype,i,o),e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="belongsTo",n.name=e.name,n.relation=t.name,n.Relation=t,e.relationList.push(n),e.relationFields.push(i),e.collection.createIndex(r),e}function G(e,t){return function(n){return n.dbg(ge,"Model:",e,"opts:",t),V(n,e,t)}}function Q(e,t,n){n||(n={});var i=n.localField||E(t.name)+"Collection",r=n.foreignKey,o=n.localKeys,a=n.foreignKeys;r||o||a||(r=n.foreignKey=E(e.name)+"Id"),r&&t.collection.createIndex(r);var u={enumerable:void 0!==n.enumerable?!!n.enumerable:!1,get:function(){if(!this._get("$"))return this._get("links."+i);var n={},u=void 0;if(r)u=t.getAll(c(this,e.idAttribute),{index:r});else if(o){var s=c(this,o)||[],l=ee(s)?s:Object.keys(s);u=t.getAll.apply(t,l)}else a&&(d(n,"where."+a+".contains",c(this,e.idAttribute)),u=t.filter(n));return this._set("links."+i,u),u},set:function(n){var u=this;return this._set("links."+i,n),n&&n.length&&!function(){var i=c(u,e.idAttribute);r?n.forEach(function(e){d(e,r,i)}):o?!function(){var e=[];n.forEach(function(n){e.push(c(n,t.idAttribute))}),d(u,o,e)}():a&&n.forEach(function(e){var t=c(e,a);t?-1===t.indexOf(i)&&t.push(i):d(e,a,[i])})}(),c(this,i)}};return(n.link===!1||void 0===n.link&&!e.linkRelations)&&(delete u.get,delete u.set,u.writable=!0),n.get&&!function(){var i=u.get;u.get=function(){var r=this;return n.get(e,t,this,i?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return i.apply(r,t)}:void 0)}}(),n.set&&!function(){var i=u.set;u.set=function(r){var o=this;return n.set(e,t,this,r,i?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return i.apply(o,t)}:void 0)}}(),Object.defineProperty(e.prototype,i,u),e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="hasMany",n.name=e.name,n.relation=t.name,n.Relation=t,e.relationList.push(n),e.relationFields.push(i),e}function Y(e,t){return function(n){return n.dbg(ye,"Model:",e,"opts:",t),Q(n,e,t)}}function Z(e,t,n){n||(n={});var i=n.localField=n.localField||E(t.name),r=n.foreignKey=n.foreignKey||E(e.name)+"Id",o={enumerable:void 0!==n.enumerable?!!n.enumerable:!1,get:function(){if(!this._get("$"))return this._get("links."+i);var n=t.getAll(c(this,e.idAttribute),{index:r}),o=n&&n.length?n[0]:void 0;return this._set("links."+i,o),o},set:function(t){return this._set("links."+i,t),d(t,r,c(this,e.idAttribute)),c(this,i)}};return(n.link===!1||void 0===n.link&&!e.linkRelations)&&(delete o.get,delete o.set),n.get&&!function(){var i=o.get;o.get=function(){var r=this;return n.get(e,t,this,i?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return i.apply(r,t)}:void 0)}}(),n.set&&!function(){var i=o.set;o.set=function(r){var o=this;return n.set(e,t,this,r,i?function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return i.apply(o,t)}:void 0)}}(),Object.defineProperty(e.prototype,i,o),e.relationList||(e.relationList=[]),e.relationFields||(e.relationFields=[]),n.type="hasOne",n.name=e.name,n.relation=t.name,n.Relation=t,e.relationList.push(n),e.relationFields.push(i),e.collection.createIndex(r),e}function H(e,t){return function(n){return n.dbg(me,"Model:",e,"opts:",t),Z(n,e,t)}}function W(e){e||(e={}),this.definitions={}}var X={};X.typeof=function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},X.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},X.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),X.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},X.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},X.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};var ee=Array.isArray,te=/^(.+)\.(.+)$/,ne=JSON.stringify,ie=/\s+/,re=/[^A-Za-z]/g,oe=/(\w)(\w*)/g,ae=Object.freeze({isArray:ee,isObject:t,isRegExp:i,isString:r,isDate:o,isNumber:a,isBoolean:u,isFunction:s,isSorN:l,get:c,unset:f,set:d,forOwn:p,deepMixIn:v,resolve:g,reject:y,_:m,intersection:b,fillIn:k,isBlacklisted:A,fromJson:x,toJson:ne,copy:w,pascalCase:O,camelCase:E,eventify:C,uuid:R}),ue={skip:"",offset:"",where:"",limit:"",orderBy:"",sort:""},se=/([.*+?^=!:${}()|[\]\/\\])/g,le=/%/g,ce=/_/g;k(P.prototype,{getData:function(){return this.data||(this.data=this.collection.index.getAll()),this.data},between:function(e,t,n){n||(n={});var i=this.collection,r=n.index?i.indexes[n.index]:i.index;if(this.data)throw new Error("Cannot access index after first operation!");return this.data=r.between(e,t,n),this},get:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],t=arguments[1];if(t||(t={}),this.data)throw new Error("Cannot access index after first operation!");if(e&&!ee(e)&&(e=[e]),!e.length)return this.getData(),this;var n=this.collection,i=t.index?n.indexes[t.index]:n.index;return this.data=i.get(e),this},getAll:function(){var e=this,n={};if(this.data)throw new Error("Cannot access index after first operation!");for(var i=arguments.length,r=Array(i),o=0;i>o;o++)r[o]=arguments[o];if(!r.length||1===r.length&&t(r[0]))return this.getData(),this;r.length&&t(r[r.length-1])&&(n=r[r.length-1],r.pop());var a=this.collection,u=n.index?a.indexes[n.index]:a.index;return this.data=[],r.forEach(function(t){e.data=e.data.concat(u.get(t))}),this},filter:function(e,n){var i=this;return e||(e={}),this.getData(),t(e)?!function(){var n={};t(e.where)&&(n=e.where),p(e,function(e,t){t in ue||t in n||(n[t]={"==":e})});var o=[],u=[],s=[];p(n,function(e,n){t(e)||(e={"==":e}),p(e,function(e,t){o.push(n),u.push(t),s.push(e)})}),o.length&&!function(){var e=void 0,t=o.length;i.data=i.data.filter(function(n){var i=!0,r=!0;for(e=0;t>e;e++){var a=u[e],l="|"===a.charAt(0);a=l?a.substr(1):a;var f=S(c(n,o[e]),a,s[e]);void 0!==f&&(r=i?f:l?r||f:r&&f),i=!1}return r})}();var l=e.orderBy||e.sort;r(l)&&(l=[[l,"ASC"]]),ee(l)||(l=null),l&&!function(){var e=0;l.forEach(function(e,t){r(e)&&(l[t]=[e,"ASC"])}),i.data.sort(function(t,n){return I(l,e,t,n)})}(),a(e.skip)?i.skip(e.skip):a(e.offset)&&i.skip(e.offset),a(e.limit)&&i.limit(e.limit)}():s(e)&&(this.data=this.data.filter(e,n)),this},skip:function(e){if(!a(e))throw new TypeError("skip: Expected number but found "+("undefined"==typeof e?"undefined":X.typeof(e))+"!");var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this},limit:function(e){if(!a(e))throw new TypeError("limit: Expected number but found "+("undefined"==typeof e?"undefined":X.typeof(e))+"!");var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},forEach:function(e,t){return this.getData().forEach(e,t),this},map:function(e,t){return this.data=this.getData().map(e,t),this},run:function(){var e=this.data;return this.data=null,e}});var fe={">":1,">=":1,"<":1,"<=":1};k(U.prototype,{set:function(e,t){ee(e)||(e=[e]);var n=e.shift()||null,i=K(this.keys,n);if(0===e.length)if(i.found){var r=K(this.values[i.index],t,this.hashCode);r.found||N(this.values[i.index],r.index,t)}else N(this.keys,i.index,n),N(this.values,i.index,[t]);else if(i.found)this.values[i.index].set(e,t);else{N(this.keys,i.index,n);var o=new U([],{hashCode:this.hashCode});o.set(e,t),N(this.values,i.index,o)}},get:function(e){ee(e)||(e=[e]);var t=e.shift()||null,n=K(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index]:[]:n.found?this.values[n.index].get(e):[]},getAll:function(){var e=[];return this.values.forEach(function(t){e=t.isIndex?e.concat(t.getAll()):e.concat(t)}),e},visitAll:function(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})},query:function(e){var t=void 0,n=void 0;if(e[">"]?(t=e[">"],e.leftInclusive=!1):e[">="]&&(t=e[">="],e.leftInclusive=!0),e["<"]?(n=e["<"],e.rightInclusive=!1):e["<="]&&(n=e["<="],e.rightInclusive=!0),t.length!==n.length)throw new Error("Key arrays must be same length");var i={};return p(e,function(e,t){fe[t]||(i[t]=e)}),this.between(t,n,i)},between:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];ee(e)||(e=[e]),ee(t)||(t=[t]),k(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var i=this._between(e,t,n);return n.limit?i.slice(n.offset,n.limit+n.offset):i.slice(n.offset)},_between:function(e,t,n){var i=[],r=e.shift(),o=t.shift(),a=void 0;if(a=void 0!==r?K(this.keys,r):{found:!1,index:0},0===e.length){a.found&&n.leftInclusive===!1&&(a.index+=1);for(var u=a.index;u<this.keys.length;u+=1){if(void 0!==o)if(n.rightInclusive){if(this.keys[u]>o)break}else if(this.keys[u]>=o)break;if(i=this.values[u].isIndex?i.concat(this.values[u].getAll()):i.concat(this.values[u]),n.limit&&i.length>=n.limit+n.offset)break}}else for(var u=a.index;u<this.keys.length;u+=1){var s=this.keys[u];if(s>o)break;if(i=this.values[u].isIndex?s===r?i.concat(this.values[u]._between(w(e),t.map(function(){}),n)):s===o?i.concat(this.values[u]._between(e.map(function(){}),w(t),n)):i.concat(this.values[u].getAll()):i.concat(this.values[u]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i},peek:function(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},remove:function(e,t){ee(e)||(e=[e]);var n=e.shift(),i=K(this.keys,n);if(0===e.length){if(i.found){var r=K(this.values[i.index],t,this.hashCode);r.found&&(D(this.values[i.index],r.index),0===this.values[i.index].length&&(D(this.keys,i.index),D(this.values,i.index)))}}else i.found&&this.values[i.index].delete(e,t)},clear:function(){this.keys=[],this.values=[]},insertRecord:function(e){var t=this.fieldList.map(function(t){return s(t)?t(e)||null:e[t]||null});this.set(t,e)},removeRecord:function(e){var t=this,n=void 0;return this.values.forEach(function(i,r){if(i.isIndex){if(i.removeRecord(e))return 0===i.keys.length&&(D(t.keys,r),D(t.values,r)),n=!0,!1}else{var o=K(i,e,t.hashCode);if(o.found)return D(i,o.index),0===i.length&&(D(t.keys,r),D(t.values,r)),n=!0,!1}}),n?e:void 0},updateRecord:function(e){this.removeRecord(e),this.insertRecord(e)}}),k(q.prototype,{_onModelEvent:function(){this.emit.apply(this,arguments)},createIndex:function(e,t){r(e)&&void 0===t&&(t=[e]);var n=this.idAttribute,i=this.indexes[e]=new U(t,{hashCode:function(e){return c(e,n)}});return this.index.visitAll(i.insertRecord,i),this},query:function(){return new P(this)},between:function(e,t,n){return this.query().between(e,t,n).run()},get:function(e,t){return this.query().get(e,t).run()},getAll:function(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},filter:function(e,t){return this.query().filter(e,t).run()},skip:function(e){return this.query().skip(e).run()},limit:function(e){return this.query().limit(e).run()},forEach:function(e,t){this.index.visitAll(e,t)},reduce:function(e,t){var n=this.getAll();return n.reduce(e,t)},map:function(e,t){var n=[];return this.index.visitAll(function(i){n.push(e.call(t,i))}),n},insert:function(e){this.index.insertRecord(e),p(this.indexes,function(t,n){t.insertRecord(e)}),e&&s(e.on)&&e.on("all",this._onModelEvent,this)},update:function(e){this.index.updateRecord(e),p(this.indexes,function(t,n){t.updateRecord(e)})},remove:function(e){this.index.removeRecord(e),p(this.indexes,function(t,n){t.removeRecord(e)}),e&&s(e.off)&&e.off("all",this._onModelEvent,this)},updateRecord:function(e,t){t||(t={});var n=t.index?this.indexes[t.index]:this.index;n.updateRecord(e)}}),C(q.prototype,function(){return this._events},function(e){this._events=e});var he={array:ee,boolean:u,integer:a,number:a,null:function(e){return null===e},object:t,string:r},de={type:function(e,t){if(void 0!==t){r(e)&&(e=[e]);var n=e.map(function(n){var i=he[n];return i?i(t)?void 0:1:"type: Unknown type "+e});return-1!==n.indexOf(void 0)?void 0:"type: Expected: "+e.join(" or ")+". Actual: "+("undefined"==typeof t?"undefined":X.typeof(t))}},anyOf:function(e,t){var n=!1,i=[];return e.forEach(function(e){var r=T(e,t);r?i=i.concat(r):n=!0}),n?void 0:i},allOf:function(e,t){var n=[];return e.forEach(function(e){n=n.concat(T(e,t)||[])}),n.length?void 0:n},oneOf:function(e,t){var n=!1,i=[];return e.forEach(function(e){var r=T(e,t);if(r)i=i.concat(r);else{if(n)return i=["more than one schema validated"],n=!1,!1;n=!0}}),n?void 0:i}},pe="setSchema",ve="registerAdapter",ge="belongsTo",ye="hasMany",me="hasOne",be=g,ke=!1;try{ke=!!window}catch(e){}var Ae=function(e,t,n,i){return n.raw?(t.adapter=i,n.autoInject&&(t.data=e.inject(t.data)),t):(n.autoInject&&(t=e.inject(t)),t)},xe=function e(){X.classCallCheck(this,e)},we=function(e){function t(e,n){X.classCallCheck(this,t);var i=X.possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));e||(e={}),n||(n={});var r={};return Object.defineProperties(i,{_get:{value:function(e){return c(r,e)}},_set:{value:function(e,t){return d(r,e,t)}},_unset:{value:function(e){return f(r,e)}}}),i._set("creating",!0),n.noValidate&&i._set("noValidate",!0),k(i,e),i._unset("creating"),i._unset("noValidate"),i._set("previous",w(e)),i}return X.inherits(t,e),X.createClass(t,[{key:"schema",value:function(e){var t=this.constructor.schema;return e?t[e]:t}},{key:"validate",value:function(e,t){var n=[],i=this.schema();if(e)if(r(e)){var o=i[e];o&&(n=T(o,t)||[])}else p(i,function(t,i){n=n.concat(T(t,c(e,i))||[])});else e=this;return n.length?n:void 0}},{key:"create",value:function(e){return this.constructor.create(this,e)}},{key:"save",value:function(e){var t=this.constructor,n=t.getAdapterName(e);return t.getAdapter(n).update(t,c(this,t.idAttribute),this,e)}},{key:"destroy",value:function(e){var t=this.constructor;return t.destroy(c(this,t.idAttribute),e)}},{key:"get",value:function(e){return c(this,e)}},{key:"set",value:function(e,t,n){return n||(n={}),d(this,e,t)}},{key:"hashCode",value:function(){return c(this,this.constructor.idAttribute)}},{key:"changes",value:function(e){return e?this._get("changes."+e):this._get("changes")}},{key:"changed",value:function(){return this._get("changed")}},{key:"hasChanges",value:function(){return!!(this._get("changed")||[]).length}},{key:"commit",value:function(){return this._unset("changed"),this._set("changes",{}),this._set("previous",w(this)),this}},{key:"previous",value:function(e){return e?this._get("previous."+e):this._get("previous")}},{key:"revert",value:function(e){var t=this,n=this._get("previous")||{};return e||(e={}),e.preserve||(e.preserve=[]),p(this,function(i,r){r!==t.constructor.idAttribute&&!n.hasOwnProperty(r)&&t.hasOwnProperty(r)&&-1===e.preserve.indexOf(r)&&delete t[r]}),p(n,function(n,i){-1===e.preserve.indexOf(i)&&(t[i]=n)}),this.commit(),this}},{key:"toJSON",value:function(e){var n=this;e||(e={});var i=this.constructor,o=this;return this instanceof t&&(o={},d(o,this),i&&i.relationList&&e.with&&(r(e.with)&&(e.with=[e.with]),i.relationList.forEach(function(t){var i=void 0;-1!==e.with.indexOf(t.relation)?i=t.relation:-1!==e.with.indexOf(t.localField)&&(i=t.localField),i&&!function(){var r={with:e.with.slice()};r.with.splice(r.with.indexOf(i),1),r.with.forEach(function(e,t){e&&0===e.indexOf(i)&&e.length>=i.length&&"."===e[i.length]?r.with[t]=e.substr(i.length+1):r.with[t]=""});var a=c(n,t.localField);a&&(ee(a)?d(o,t.localField,a.map(function(e){return t.Relation.prototype.toJSON.call(e,r)})):d(o,t.localField,t.Relation.prototype.toJSON.call(a,r)))}()}))),o}}],[{key:"createIndex",value:function(e,t){this.dbg("createIndex","name:",e,"keyList:",t),this.collection.createIndex(e,t)}},{key:"createInstance",value:function(e){var t=this;return e instanceof t?e:new t(e)}},{key:"is",value:function(e){return e instanceof this}},{key:"getAutoPkItems",value:function(){return this.getAll().filter(function(e){return e._get("autoPk")})}},{key:"inject",value:function(e,t){var n=this,i="inject";n.dbg(i,"item(s):",e,"opts:",t),t||(t={}),t.op=i;var r=!1,o=n.collection,a=n.idAttribute,u=n.relationList||[];return ee(e)||(e=[e],r=!0),e=e.map(function(e){var i=c(e,a),r=!1;if(!l(i)){if(!(t.autoPk||void 0===t.autoPk&&n.autoPk))throw new TypeError("User#"+a+": Expected string or number, found "+("undefined"==typeof i?"undefined":X.typeof(i))+"!");i=R(),d(e,a,i),r=!0}var h=n.get(i);if(e===h)return h;if(u.forEach(function(t){var r=t.Relation,o=r.idAttribute,u=t.foreignKey,l=c(e,t.localField);if(s(t.inject))t.inject(n,t,e);else if(l&&t.inject!==!1)if(ee(l))l=l.map(function(e){if(e!==r.get(c(e,o)))try{u&&d(e,u,i),e=r.inject(e)}catch(e){throw new Error("Failed to inject "+t.type+' relation: "'+t.relation+'"! '+e.message)}return e}),t.localKeys&&d(e,t.localKeys,l.map(function(e){return c(e,o)}));else if(l!==r.get(c(l,o)))try{t.localKey&&d(e,t.localKey,c(l,r.idAttribute)),u&&d(l,t.foreignKey,c(e,a)),l=r.inject(l)}catch(e){throw new Error("Failed to inject "+t.type+' relation: "'+t.relation+'"!')}t.link||void 0===t.link&&n.linkRelations?f(e,t.localField):d(e,t.localField,l)}),h){var g=t.onConflict||n.onConflict;"merge"===g?v(h,e):"replace"===g&&(p(h,function(t,n){n===a||e.hasOwnProperty(n)||delete h[n]}),h.set(e)),e=h,o.update(e)}else e=n.createInstance(e),e._set("$",!0),r&&e._set("autoPk",r),o.insert(e);return e}),r?e.length?e[0]:void 0:e}},{key:"eject",value:function(e,t){var n="eject";this.dbg(n,"id:",e,"opts:",t),t||(t={}),t.op=n;var i=this.get(e);return i&&(i._unset("$"),this.collection.remove(i)),i}},{key:"ejectAll",value:function(e,t){var n="ejectAll";this.dbg(n,"params:",e,"opts:",t),t||(t={}),t.op=n;var i=this.filter(e),r=this.collection;return i.forEach(function(e){r.remove(e)}),i}},{key:"get",value:function(e){this.dbg("get","id:",e);var t=this.collection.get(e);return t.length?t[0]:void 0}},{key:"between",value:function(){var e;return(e=this.collection).between.apply(e,arguments)}},{key:"getAll",value:function(){var e;return(e=this.collection).getAll.apply(e,arguments)}},{key:"filter",value:function(e,t){return t||(t={}),this.collection.filter(e,t)}},{key:"query",value:function(){return this.collection.query()}},{key:"getAdapter",value:function(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw new ReferenceError(t+" not found!");return this.adapters[t]}},{key:"getAdapterName",value:function(e){return e||(e={}),r(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter}},{key:"beforeCreate",value:function(){}},{key:"create",value:function(e,t){var n=this,i="create";this.dbg(i,"props:",e,"opts:",t);var r=void 0;return e||(e={}),t||(t={}),m(this,t),t.op=i,!t.upsert||!c(e,this.idAttribute)||this.is(e)&&e._get("autoPk")?be(this.beforeCreate(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).create(n,n.prototype.toJSON.call(e,t),t)}).then(function(i){return be(n.afterCreate(i,t)).then(function(){return n.is(e)&&e._get("$")&&n.eject(c(e,n.idAttribute)),Ae(n,i,t,r)})}):this.update(c(e,this.idAttribute),e,t)}},{key:"afterCreate",value:function(){}},{key:"beforeCreateMany",value:function(){}},{key:"createMany",value:function(e,t){var n=this,i="createMany";this.dbg(i,"items:",e,"opts:",t);var r=void 0;if(e||(e=[]),t||(t={}),m(this,t),t.op=i,t.upsert){var o=function(){var i=!0;return e.forEach(function(e){i=i&&c(e,n.idAttribute)&&(!s(e._get)||!e._get("autoPk"))}),i?{v:n.updateMany(e,t)}:void 0}();if("object"===("undefined"==typeof o?"undefined":X.typeof(o)))return o.v}return be(this.beforeCreateMany(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).createMany(n,e.map(function(e){return n.prototype.toJSON.call(e,t)}),t)}).then(function(i){return be(n.afterCreateMany(i,t)).then(function(){return e.forEach(function(e){n.is(e)&&e._get("$")&&n.eject(c(e,n.idAttribute))}),Ae(n,i,t,r)})})}},{key:"afterCreateMany",value:function(){}},{key:"beforeFind",value:function(){}},{key:"find",value:function(e,t){var n=this,i="find";this.dbg(i,"id:",e,"opts:",t);var r=void 0;return t||(t={}),m(this,t),t.op=i,be(this.beforeFind(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).find(n,e,t)}).then(function(e){return be(n.afterFind(e,t)).then(function(){return Ae(n,e,t,r)})})}},{key:"afterFind",value:function(){}},{key:"beforeFindAll",value:function(){}},{key:"findAll",value:function(e,t){var n=this,i="findAll";this.dbg(i,"query:",e,"opts:",t);var r=void 0;return e||(e={}),t||(t={}),m(this,t),t.op=i,be(this.beforeFindAll(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).findAll(n,e,t)}).then(function(e){return be(n.afterFindAll(e,t)).then(function(){return Ae(n,e,t,r)})})}},{key:"afterFindAll",value:function(){}},{key:"beforeUpdate",value:function(){}},{key:"update",value:function(e,t,n){var i=this,r="update";this.dbg(r,"id:",e,"props:",t,"opts:",n);var o=void 0;return t||(t={}),n||(n={}),m(this,n),n.op=r,be(this.beforeUpdate(e,t,n)).then(function(){return o=i.getAdapterName(n),i.getAdapter(o).update(i,e,i.prototype.toJSON.call(t,n),n)}).then(function(t){return be(i.afterUpdate(e,t,n)).then(function(){return Ae(i,t,n,o)})})}},{key:"afterUpdate",value:function(){}},{key:"beforeUpdateMany",value:function(){}},{key:"updateMany",value:function(e,t){var n=this,i="updateMany";this.dbg(i,"items:",e,"opts:",t);var r=void 0;return e||(e=[]),t||(t={}),m(this,t),t.op=i,be(this.beforeUpdateMany(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).updateMany(n,e.map(function(e){return n.prototype.toJSON.call(e,t)}),t)}).then(function(e){return be(n.afterUpdateMany(e,t)).then(function(){return Ae(n,e,t,r)})})}},{key:"afterUpdateMany",value:function(){}},{key:"beforeUpdateAll",value:function(){}},{key:"updateAll",value:function(e,t,n){var i=this,r="updateAll";this.dbg(r,"query:",e,"props:",t,"opts:",n);var o=void 0;return e||(e={}),t||(t={}),n||(n={}),m(this,n),n.op=r,be(this.beforeUpdateAll(e,t,n)).then(function(){return o=i.getAdapterName(n),i.getAdapter(o).updateAll(i,e,t,n)}).then(function(t){return be(i.afterUpdateAll(e,t,n)).then(function(){return Ae(i,t,n,o)})})}},{key:"afterUpdateAll",value:function(){}},{key:"beforeDestroy",value:function(){}},{key:"destroy",value:function(e,t){var n=this,i="destroy";this.dbg(i,"id:",e,"opts:",t);var r=void 0;return t||(t={}),m(this,t),t.op=i,be(this.beforeDestroy(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).destroy(n,e,t)}).then(function(i){return be(n.afterDestroy(e,t)).then(function(){return t.raw?(i.adapter=r,t.autoEject&&(i.data=n.eject(e,t)),i):(t.autoEject&&(i=n.eject(e,t)),i)})})}},{key:"afterDestroy",value:function(){}},{key:"beforeDestroyAll",value:function(){}},{key:"destroyAll",value:function(e,t){var n=this,i="destroyAll";this.dbg(i,"query:",e,"opts:",t);var r=void 0;return e||(e={}),t||(t={}),m(this,t),t.op=i,be(this.beforeDestroyAll(e,t)).then(function(){return r=n.getAdapterName(t),n.getAdapter(r).destroyAll(n,e,t)}).then(function(i){return be(n.afterDestroyAll(e,t)).then(function(){return t.raw?(i.adapter=r,t.autoEject&&(i.data=n.ejectAll(e,t)),
i):(t.autoEject&&(i=n.ejectAll(e,t)),i)})})}},{key:"afterDestroyAll",value:function(){}},{key:"beforeLoadRelations",value:function(){}},{key:"loadRelations",value:function(e,t,n){var i=this,o=this,a=o.is(e)?e:void 0;e=a?c(a,o.idAttribute):e;var u="loadRelations";o.dbg(u,"id:",e,"relations:",t,"opts:",n),t||(t=[]),n||(n={});var f=o.relationList||[];return m(o,n),n.op=u,be(o.beforeLoadRelations(e,t,n)).then(function(){if(l(e)&&!a&&(a=o.get(a)),!a)throw new Error("You passed an id of an instance not found in the collection of the Model!");return r(t)&&(t=[t]),Promise.all(f.map(function(t){if(s(t.load))return t.load(o,t,a,n);var i=void 0;if(t.foreignKey)i=t.Relation.findAll(X.defineProperty({},t.foreignKey,e),n);else if(t.localKey){var r=c(a,t.localKey);l(r)&&(i=t.Relation.find(r,n))}else t.localKeys?i=t.Relation.findAll(X.defineProperty({},t.Relation.idAttribute,{in:c(a,t.localKeys)}),n):t.foreignKeys&&(i=t.Relation.findAll(X.defineProperty({},t.Relation.idAttribute,{contains:c(a,o.idAttribute)}),n));return i&&(i=i.then(function(e){n.raw&&(e=e.data),d(a,t.localField,"hasOne"===t.type?e.length?e[0]:void 0:e)})),i}))}).then(function(){return be(i.afterLoadRelations(a,t,n)).then(function(){return a})})}},{key:"afterLoadRelations",value:function(){}},{key:"log",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;t>i;i++)n[i-1]=arguments[i];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var r=e.toUpperCase()+": ("+this.name+")";if(console[e]){var o;(o=console)[e].apply(o,[r].concat(n))}else{var a;(a=console).log.apply(a,[r].concat(n))}}}},{key:"dbg",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},{key:"belongsTo",value:function(e,t){return G(e,t)(this)}},{key:"hasMany",value:function(e,t){return Y(e,t)(this)}},{key:"hasOne",value:function(e,t){return H(e,t)(this)}},{key:"setSchema",value:function(e){return z(e)(this)}},{key:"configure",value:function(e){return $(e)(this)}},{key:"registerAdapter",value:function(e,t,n){return B(e,t,n)(this)}},{key:"extend",value:function(e,t){var n=this,i=void 0;n.dbg("extend","props:",e,"classProps:",t),e||(e={}),t||(t={});var r=e.initialize;if(delete e.initialize,e.hasOwnProperty("constructor"))i=e.constructor,delete e.constructor;else{if(!t.name)throw new TypeError("name: Expected string, found "+X.typeof(t.name)+"!");if(t.csp)i=function(){X.classCallCheck(this,i);for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];var o=X.possibleConstructorReturn(this,Object.getPrototypeOf(i).apply(this,t));return r&&r.apply(this,t),o};else{var o=O(t.name),a="return function "+o+"() {\n                        __callCheck__(this, "+o+")\n                        var _this = __possibleConstructorReturn__(this, Object.getPrototypeOf("+o+").apply(this, arguments));\n                        if (initialize) {\n                          initialize.apply(this, arguments)\n                        }\n                        return _this\n                      }";i=new Function("__callCheck__","__possibleConstructorReturn__","Parent","initialize",a)(X.classCallCheck,X.possibleConstructorReturn,n,r)}}t.shortname=t.shortname||E(i.name||t.name),delete t.name;var u=t.schema;return delete t.schema,X.inherits(i,n),$(e)(i.prototype),$(t)(i),u&&z(u)(i),i}}]),t}(xe);we.__events={},Object.defineProperty(we,"_events",{get:function(){return this.__events===Object.getPrototypeOf(this).__events&&(this.__events={}),this.__events}}),we._adapters={},Object.defineProperty(we,"adapters",{get:function(){var e=Object.getPrototypeOf(this)._adapters;return this._adapters===e&&(this._adapters={},k(this._adapters,e)),this._adapters}}),we._collection=new q([],"id"),Object.defineProperty(we,"collection",{get:function(){return this._collection===Object.getPrototypeOf(this)._collection&&(this._collection=new q([],this.idAttribute),this._collection.on("all",this.emit,this)),this._collection}}),we.autoEject=!0,we.autoInject=ke,we.bypassCache=!1,we.csp=!1,we.defaultAdapter="http",we.debug=!1,we.eagerEject=!1,we.idAttribute="id",we.linkRelations=ke,we.onConflict="merge",we.relationsEnumerable=!1,we.raw=!1,we.upsert=!0,C(we,function(){return this._events},function(e){this._events=e}),C(we.prototype,function(){return this._get("events")},function(e){this._set("events",e)}),k(W.prototype,{clear:function(){var e={};return p(this.definitions,function(t){var n=t.name;e[n]=t.ejectAll()}),e},defineModel:function(e){var t=we.extend(e.methods||{},e);return this.definitions[t.name]=t,t}}),W.prototype.defineResource=W.prototype.defineModel,p(we,function(e,t){s(e)&&(W.prototype[t]=function(e){var n;if(!this.definitions[e])throw new Error(e+" is not a registered Model!");for(var i=arguments.length,r=Array(i>1?i-1:0),o=1;i>o;o++)r[o-1]=arguments[o];return(n=this.definitions[e])[t].apply(n,r)})}),Promise.prototype.spread||(Promise.prototype.spread=function(e){return this.then(function(t){return e.apply(this,t)})});var _e=ae,je={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"};e.utils=_e,e.version=je,e.Collection=q,e.Query=P,e.DS=W,e.belongsTo=G,e.configure=$,e.hasMany=Y,e.hasOne=H,e.setSchema=z,e.registerAdapter=B,e.Model=we,e.rules=de,e.validate=T});
//# sourceMappingURL=dist/js-data.min.map